<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نتائج الكويزات</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #FF8C00;
      --primary-light: #FFA500;
      --primary-dark: #FF7F00;
      --secondary: #333333;
      --light: #FFF5E6;
      --white: #FFFFFF;
      --gray: #777777;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      background: linear-gradient(135deg, var(--light) 0%, #fdf6ec 100%);
      color: var(--secondary);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
    }
    
    .header h1 {
      color: var(--primary-dark);
      font-size: 2.5rem;
      margin-bottom: 10px;
      position: relative;
      display: inline-block;
    }
    
    .header h1::after {
      content: '';
      position: absolute;
      bottom: -10px;
      right: 50%;
      transform: translateX(50%);
      width: 80px;
      height: 4px;
      background: var(--primary);
      border-radius: 2px;
    }
    
    .header p {
      color: var(--gray);
      font-size: 1.1rem;
    }
    
    .search-container {
      background: var(--white);
      border-radius: 50px;
      box-shadow: 0 5px 15px rgba(255, 140, 0, 0.15);
      margin: 0 auto 40px;
      max-width: 700px;
      padding: 5px;
      position: relative;
    }
    
    .search-box {
      display: flex;
      align-items: center;
    }
    
    .search-box input {
      flex: 1;
      border: none;
      padding: 15px 20px;
      font-size: 16px;
      border-radius: 50px;
      outline: none;
      background: transparent;
      color: var(--secondary);
    }
    
    .search-box button {
      background: var(--primary);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .search-box button:hover {
      background: var(--primary-dark);
      transform: rotate(10deg);
    }
    
    .filters {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-btn {
      background: var(--white);
      border: 2px solid var(--primary-light);
      border-radius: 30px;
      color: var(--primary-dark);
      cursor: pointer;
      padding: 8px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .filter-btn:hover, .filter-btn.active {
      background: var(--primary);
      color: var(--white);
    }
    
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 25px;
      margin: 0 auto;
      max-width: 1400px;
    }
    
    .card {
      background: linear-gradient(135deg, var(--white) 0%, #fff8f0 100%);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(255, 140, 0, 0.15);
      margin: 10px;
      padding: 20px;
      width: 320px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 140, 0, 0.1);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--primary-light), var(--primary-dark));
    }
    
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 25px rgba(255, 140, 0, 0.25);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 140, 0, 0.2);
    }
    
    .student-name {
      font-size: 1.4rem;
      color: var(--primary-dark);
      font-weight: 700;
    }
    
    .student-id {
      background: var(--primary);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .card-detail {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    
    .icon {
      width: 28px;
      height: 28px;
      background: var(--light);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
      color: var(--primary);
    }
    
    .detail-text {
      flex: 1;
      font-size: 0.95rem;
    }
    
    .score-container {
      margin-top: 20px;
      background: var(--light);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }
    
    .score {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--primary-dark);
      margin: 5px 0;
    }
    
    .total-score {
      color: var(--gray);
      font-size: 1rem;
    }
    
    .progress-bar {
      height: 8px;
      background: #e6e6e6;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-light), var(--primary-dark));
      border-radius: 4px;
    }
    
    .timestamp {
      text-align: left;
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px dashed rgba(255, 140, 0, 0.2);
    }
    
    .no-results {
      text-align: center;
      padding: 40px;
      color: var(--gray);
      font-size: 1.2rem;
    }
    
    .no-results i {
      font-size: 3rem;
      color: var(--primary-light);
      margin-bottom: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--primary);
      font-size: 1.2rem;
    }
    
    .loading i {
      font-size: 3rem;
      margin-bottom: 20px;
      animation: spin 1.5s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .container {
        gap: 15px;
      }
      
      .card {
        width: 100%;
        max-width: 400px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
    }
  </style>
  
  <!-- Firebase App (الجزء الأساسي من Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <div class="header">
    <h1>نتائج الكويزات</h1>
    <p>اطلع على نتائج الطلاب في مختلف الكويزات</p>
  </div>

  <div class="search-container">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="ابحث بالاسم أو الكود أو الصف أو اسم الكورس...">
      <button id="searchButton">
        <i class="fas fa-search"></i>
      </button>
    </div>
  </div>

  <div class="filters">
    <button class="filter-btn active" data-filter="all">الكل</button>
    <button class="filter-btn" data-filter="grade">الصف</button>
    <button class="filter-btn" data-filter="courseName">الكورس</button>
    <button class="filter-btn" data-filter="governorate">المحافظة</button>
  </div>

  <div class="container" id="quizContainer">
    <div class="loading">
      <i class="fas fa-spinner"></i>
      <p>جاري تحميل البيانات...</p>
    </div>
  </div>

  <script>
    // تهيئة Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCYTyLhaju2pz9Qm8kcOmouj021ZHsD7Ak",
      authDomain: "corss-cee70.firebaseapp.com",
      projectId: "corss-cee70",
      storageBucket: "corss-cee70.firebasestorage.app",
      messagingSenderId: "252749122878",
      appId: "1:252749122878:web:decad07aec6ed917a4b06f",
      measurementId: "G-7G2SDLRBZ8"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // العناصر في واجهة المستخدم
    const container = document.getElementById("quizContainer");
    const searchInput = document.getElementById("searchInput");
    const searchButton = document.getElementById("searchButton");
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    // مصفوفة لتخزين البيانات
    let quizzes = [];
    let filteredQuizzes = [];

    // دالة جلب البيانات من Firebase
    function fetchQuizzes() {
      container.innerHTML = `
        <div class="loading">
          <i class="fas fa-spinner"></i>
          <p>جاري تحميل البيانات...</p>
        </div>
      `;
      
      db.collection("quiz").get()
        .then((querySnapshot) => {
          quizzes = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            data.id = doc.id;
            quizzes.push(data);
          });
          
          renderQuizzes(quizzes);
          filteredQuizzes = [...quizzes];
        })
        .catch((error) => {
          console.error("Error getting documents: ", error);
          container.innerHTML = `
            <div class="no-results">
              <i class="fas fa-exclamation-triangle"></i>
              <p>حدث خطأ في تحميل البيانات</p>
              <p>${error.message}</p>
            </div>
          `;
        });
    }

    // دالة عرض الكروت
    function renderQuizzes(data) {
      container.innerHTML = "";
      
      if (data.length === 0) {
        container.innerHTML = `
          <div class="no-results">
            <i class="fas fa-search"></i>
            <p>لا توجد نتائج تطابق البحث</p>
          </div>
        `;
        return;
      }
      
      data.forEach(q => {
        const percentage = (q.score / q.total) * 100;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-header">
            <div class="student-name">${q.name || "غير معروف"}</div>
            <div class="student-id">${q.studentId || "لا يوجد"}</div>
          </div>
          
          <div class="card-detail">
            <div class="icon"><i class="fas fa-graduation-cap"></i></div>
            <div class="detail-text">${q.grade || "غير محدد"}</div>
          </div>
          
          <div class="card-detail">
            <div class="icon"><i class="fas fa-school"></i></div>
            <div class="detail-text">${q.school || "غير محدد"}</div>
          </div>
          
          <div class="card-detail">
            <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
            <div class="detail-text">${q.governorate || "غير محدد"}</div>
          </div>
          
          <div class="card-detail">
            <div class="icon"><i class="fas fa-book"></i></div>
            <div class="detail-text">${q.courseName || "غير محدد"}</div>
          </div>
          
          <div class="score-container">
            <div>النتيجة</div>
            <div class="score">${q.score || 0}<span class="total-score">/${q.total || 0}</span></div>
            <div class="progress-bar">
              <div class="progress" style="width: ${percentage}%"></div>
            </div>
            <div>${percentage.toFixed(1)}%</div>
          </div>
          
          <div class="timestamp">
            <i class="far fa-clock"></i> ${q.timestamp ? formatTimestamp(q.timestamp) : "غير معروف"}
          </div>
        `;
        container.appendChild(card);
      });
    }

    // دالة تنسيق الطابع الزمني
    function formatTimestamp(timestamp) {
      if (typeof timestamp === 'string') {
        return timestamp;
      }
      
      try {
        // إذا كان timestamp من Firebase
        if (timestamp.toDate) {
          const date = timestamp.toDate();
          return date.toLocaleString('ar-EG');
        }
        
        return "غير معروف";
      } catch (error) {
        console.error("Error formatting timestamp:", error);
        return "غير معروف";
      }
    }

    // دالة البحث والتصفية
    function filterQuizzes() {
      const value = searchInput.value.toLowerCase();
      const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
      
      if (!value) {
        renderQuizzes(quizzes);
        filteredQuizzes = [...quizzes];
        return;
      }
      
      const filtered = quizzes.filter(q => {
        // إذا كان البحث عام (الكل)
        if (activeFilter === 'all') {
          return (
            (q.name && q.name.toLowerCase().includes(value)) ||
            (q.studentId && q.studentId.toLowerCase().includes(value)) ||
            (q.grade && q.grade.toLowerCase().includes(value)) ||
            (q.courseName && q.courseName.toLowerCase().includes(value)) ||
            (q.governorate && q.governorate.toLowerCase().includes(value)) ||
            (q.school && q.school.toLowerCase().includes(value))
          );
        }
        
        // إذا كان البحث بحقل محدد
        if (activeFilter && q[activeFilter]) {
          return q[activeFilter].toLowerCase().includes(value);
        }
        
        return false;
      });
      
      renderQuizzes(filtered);
      filteredQuizzes = [...filtered];
    }

    // أحداث البحث
    searchInput.addEventListener("input", filterQuizzes);
    searchButton.addEventListener("click", filterQuizzes);

    // أحداث الأزرار
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        // تغيير placeholder بناءً على الزر المختار
        if (button.dataset.filter === 'all') {
          searchInput.placeholder = 'ابحث بالاسم أو الكود أو الصف أو اسم الكورس...';
        } else if (button.dataset.filter === 'grade') {
          searchInput.placeholder = 'ابحث باسم الصف...';
        } else if (button.dataset.filter === 'courseName') {
          searchInput.placeholder = 'ابحث باسم الكورس...';
        } else if (button.dataset.filter === 'governorate') {
          searchInput.placeholder = 'ابحث باسم المحافظة...';
        }
        
        filterQuizzes();
      });
    });

    // جلب البيانات عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', fetchQuizzes);
  </script>

</body>
</html>