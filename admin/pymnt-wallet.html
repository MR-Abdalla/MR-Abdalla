<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
    const firebaseConfig = {
      apiKey: "AIzaSyBu1tQfkvavnVsWBfXr5wV1j6QFDmmeCw0",
      authDomain: "wallet-cf1bb.firebaseapp.com",
      projectId: "wallet-cf1bb",
      storageBucket: "wallet-cf1bb.firebasestorage.app",
      messagingSenderId: "729732138811",
      appId: "1:729732138811:web:5cfa382f358c869e47d91e",
      measurementId: "G-KYBPBZKHQ6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ğŸ”¹ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
    async function getStudent() {
      const studentId = document.getElementById("studentId").value.trim();
      if (!studentId) {
        showAlert("Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹", "warning");
        return;
      }

      const loadingEl = document.getElementById("loading");
      loadingEl.style.display = "block";
      
      try {
        const ref = doc(db, "wallets", studentId);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
          document.getElementById("studentInfo").innerHTML = `
            <div class="alert-message warning">
              <i class="icon">âš ï¸</i>
              <span>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø§Ù„Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯</span>
            </div>
          `;
          return;
        }

        const data = snap.data();
        document.getElementById("studentInfo").innerHTML = `
          <div class="student-card">
            <div class="student-header">
              <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
              <span class="balance">${data.balance} Ø¬Ù†ÙŠÙ‡</span>
            </div>
            <div class="student-details">
              <div class="detail-item">
                <span class="label">Ø§Ù„Ø§Ø³Ù…:</span>
                <span class="value">${data.name}</span>
              </div>
              <div class="detail-item">
                <span class="label">Ø§Ù„ØµÙ:</span>
                <span class="value">${data.grade}</span>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error("Error fetching student:", error);
        showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨", "error");
      } finally {
        loadingEl.style.display = "none";
      }
    }

    // ğŸ”¹ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    function toggleReason() {
      const type = document.querySelector('input[name="type"]:checked')?.value;
      const reasonBox = document.getElementById("reasonBox");
      reasonBox.style.display = (type === "withdraw") ? "block" : "none";
    }

    // ğŸ”¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø¯ÙˆÙƒÙŠÙˆÙ…Ù†Øª + ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
    async function handleTransaction() {
      const studentId = document.getElementById("studentId").value.trim();
      const amount = parseFloat(document.getElementById("amount").value);
      const type = document.querySelector('input[name="type"]:checked')?.value;
      const reason = document.getElementById("reason").value.trim();

      if (!studentId || isNaN(amount) || !type) {
        showAlert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©", "warning");
        return;
      }

      if (type === "withdraw" && !reason) {
        showAlert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„ØºØ±Ø¶ Ù…Ù† Ø§Ù„Ø®ØµÙ…", "warning");
        return;
      }

      try {
        const ref = doc(db, "wallets", studentId);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
          showAlert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø§Ù„Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯", "error");
          return;
        }

        const data = snap.data();
        let newBalance = data.balance;

        if (type === "deposit") {
          newBalance += amount;
        } else if (type === "withdraw") {
          if (amount > newBalance) {
            showAlert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ!", "error");
            return;
          }
          newBalance -= amount;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        const newTransaction = {
          type: type,
          amount: amount,
          reason: (type === "withdraw" ? reason : ""),
          createdAt: new Date().toLocaleString('ar-EG'),
        };

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        await updateDoc(ref, {
          balance: newBalance,
          transactions: arrayUnion(newTransaction)
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
        const balanceElement = document.querySelector("#studentInfo .balance");
        if (balanceElement) {
          balanceElement.textContent = `${newBalance} Ø¬Ù†ÙŠÙ‡`;
        }

        showAlert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ø·Ø§Ù„Ø¨ ${data.name}<br>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newBalance} Ø¬Ù†ÙŠÙ‡`, "success");

        // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById("amount").value = "";
        document.getElementById("reason").value = "";
        document.querySelectorAll('input[name="type"]').forEach(radio => {
          radio.checked = false;
        });
        document.getElementById("reasonBox").style.display = "none";
      } catch (error) {
        console.error("Error processing transaction:", error);
        showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "error");
      }
    }

    // ğŸ”¹ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
    function showAlert(message, type) {
      const alertDiv = document.createElement("div");
      alertDiv.className = `alert ${type}`;
      alertDiv.innerHTML = `
        <i class="icon">${type === "success" ? "âœ…" : type === "warning" ? "âš ï¸" : "âŒ"}</i>
        <span>${message}</span>
        <button class="close-alert" onclick="this.parentElement.remove()">Ã—</button>
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.classList.add("show");
      }, 10);
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
      setTimeout(() => {
        if (alertDiv.parentElement) {
          alertDiv.classList.remove("show");
          setTimeout(() => {
            if (alertDiv.parentElement) {
              document.body.removeChild(alertDiv);
            }
          }, 300);
        }
      }, 5000);
    }

    // âœ… Ø¹Ù„Ø´Ø§Ù† ÙŠØ´ØªØºÙ„ onclick
    window.getStudent = getStudent;
    window.handleTransaction = handleTransaction;
    window.toggleReason = toggleReason;
  </script>

  <style>
    :root {
      --primary: #FF7A00;
      --primary-light: #FF9A42;
      --primary-dark: #E06A00;
      --secondary: #2D3748;
      --light-bg: #FFF9F2;
      --white: #FFFFFF;
      --gray-light: #F7FAFC;
      --gray: #E2E8F0;
      --gray-dark: #A0AEC0;
      --success: #48BB78;
      --warning: #ED8936;
      --error: #F56565;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--light-bg);
      color: var(--secondary);
      text-align: center;
      padding: 20px;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .container {
      max-width: 400px;
      margin: 0 auto;
      width: 100%;
    }

    .logo {
      margin-bottom: 25px;
    }

    .logo h1 {
      color: var(--primary);
      font-size: 28px;
      margin-bottom: 5px;
    }

    .logo p {
      color: var(--gray-dark);
      font-size: 14px;
    }

    .box {
      background: var(--white);
      padding: 25px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    h2 {
      color: var(--secondary);
      margin-bottom: 20px;
      font-weight: 700;
      position: relative;
      padding-bottom: 10px;
    }

    h2:after {
      content: '';
      position: absolute;
      bottom: 0;
      right: 0;
      width: 50px;
      height: 3px;
      background: var(--primary);
      border-radius: 2px;
    }

    .input-group {
      margin-bottom: 15px;
      text-align: right;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--secondary);
    }

    input, textarea, select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--gray);
      border-radius: 8px;
      font-family: 'Tajawal', sans-serif;
      font-size: 16px;
      transition: all 0.3s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.2);
    }

    .search-container {
      display: flex;
      gap: 10px;
    }

    .search-container input {
      flex: 1;
    }

    button {
      background: var(--primary);
      color: var(--white);
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Tajawal', sans-serif;
      font-weight: 500;
      font-size: 16px;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 122, 0, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-full {
      width: 100%;
    }

    .radio-group {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
      gap: 10px;
    }

    .radio-option {
      flex: 1;
      position: relative;
    }

    .radio-option input {
      display: none;
    }

    .radio-label {
      display: block;
      padding: 12px 15px;
      background: var(--gray-light);
      border: 2px solid var(--gray);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    .radio-option input:checked + .radio-label {
      background: rgba(255, 122, 0, 0.1);
      border-color: var(--primary);
      color: var(--primary);
    }

    #reasonBox {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    #studentInfo {
      margin: 20px 0;
      animation: fadeIn 0.5s ease;
    }

    .student-card {
      background: var(--gray-light);
      border-radius: var(--radius);
      overflow: hidden;
      text-align: right;
    }

    .student-header {
      background: var(--primary);
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .student-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .balance {
      font-size: 20px;
      font-weight: 700;
    }

    .student-details {
      padding: 15px;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .detail-item:last-child {
      margin-bottom: 0;
    }

    .label {
      font-weight: 500;
      color: var(--secondary);
    }

    .value {
      color: var(--primary-dark);
    }

    .loading {
      display: none;
      text-align: center;
      padding: 15px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 122, 0, 0.2);
      border-left: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      left: 20px;
      max-width: 400px;
      margin: 0 auto;
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      transform: translateY(-20px);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .alert.show {
      transform: translateY(0);
      opacity: 1;
    }

    .alert.success {
      border-right: 4px solid var(--success);
    }

    .alert.warning {
      border-right: 4px solid var(--warning);
    }

    .alert.error {
      border-right: 4px solid var(--error);
    }

    .alert .icon {
      font-size: 20px;
    }

    .close-alert {
      background: none;
      color: var(--gray-dark);
      padding: 0;
      width: 24px;
      height: 24px;
      margin-right: auto;
      font-size: 18px;
    }

    .close-alert:hover {
      background: none;
      color: var(--secondary);
      transform: none;
      box-shadow: none;
    }

    .alert-message {
      padding: 10px 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-message.warning {
      background: rgba(237, 137, 54, 0.1);
      color: var(--warning);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      .container {
        padding: 10px;
      }
      
      .box {
        padding: 20px 15px;
      }
      
      .radio-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©</h1>
      <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</p>
    </div>

    <div class="box">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©</h2>

      <div class="input-group">
        <div class="search-container">
          <input type="text" id="studentId" placeholder="Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
          <button onclick="getStudent()">Ø¨Ø­Ø«</button>
        </div>
      </div>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨...</p>
      </div>

      <div id="studentInfo"></div>

      <div class="input-group">
        <input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡" min="0" step="0.01">
      </div>

      <div class="radio-group" onchange="toggleReason()">
        <div class="radio-option">
          <input type="radio" id="deposit" name="type" value="deposit">
          <label for="deposit" class="radio-label">Ø¥ÙŠØ¯Ø§Ø¹</label>
        </div>
        <div class="radio-option">
          <input type="radio" id="withdraw" name="type" value="withdraw">
          <label for="withdraw" class="radio-label">Ø®ØµÙ…</label>
        </div>
      </div>

      <div id="reasonBox">
        <div class="input-group">
          <textarea id="reason" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØºØ±Ø¶ Ù…Ù† Ø§Ù„Ø®ØµÙ…"></textarea>
        </div>
      </div>

      <button class="btn-full" onclick="handleTransaction()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
    </div>
  </div>
<script>
  let leaveTime = null; // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù„ÙŠ Ø³Ø§Ø¨ ÙÙŠÙ‡ Ø§Ù„ØµÙØ­Ø© Ø¢Ø®Ø± Ù…Ø±Ø©

  // Ù„Ù…Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³ÙŠØ¨ Ø§Ù„ØµÙØ­Ø© (ÙŠØ±ÙˆØ­ ØªØ¨ÙˆÙŠØ¨ ØªØ§Ù†ÙŠ)
  window.addEventListener("blur", () => {
    leaveTime = Date.now(); // Ù†Ø³Ø¬Ù„ ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬
  });

  // Ù„Ù…Ø§ ÙŠØ±Ø¬Ø¹ Ù„Ù„ØµÙØ­Ø©
  window.addEventListener("focus", () => {
    if (leaveTime) {
      const now = Date.now();
      const diffMinutes = (now - leaveTime) / 60000; // Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø¯Ù‚Ø§ÙŠÙ‚

      // Ù„Ùˆ Ø¹Ø¯Ù‘Ù‰ Ø£ÙƒØªØ± Ù…Ù† 5 Ø¯Ù‚Ø§ÙŠÙ‚
      if (diffMinutes > 5) {
        location.reload(); // Ù†Ø¹Ù…Ù„ Ø±ÙŠÙØ±Ø´
      }
    }
  });
</script>

</body>
</html>