<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الدفع الطلابي</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-card-heading"></i> نظام البطاقات</h3>
        </div>
        <ul class="sidebar-menu">
            <li><a href="card.html"><i class="bi bi-person-plus"></i> إنشاء بطاقة</a></li>
            <li class="active"><a href="payment.html"><i class="bi bi-cash-coin"></i> الدفع</a></li>
            <li><a href="#"><i class="bi bi-search"></i> البحث</a></li>
            <li><a href="#"><i class="bi bi-gear"></i> الإعدادات</a></li>
        </ul>
    </div>

    <div class="main-content">
        <nav class="navbar">
            <div class="navbar-title">نظام الدفع الطلابي</div>
            <div class="navbar-user">
                <img src="https://via.placeholder.com/40" alt="User" class="user-avatar">
                <span>مسؤول النظام</span>
            </div>
        </nav>

        <div class="content-container">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card animate__animated animate__fadeIn">
                        <div class="card-header">
                            <h4><i class="bi bi-search"></i> البحث عن طالب</h4>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
                                        <input type="text" class="form-control" id="searchCode" placeholder="أدخل كود الطالب">
                                        <button class="btn btn-primary" id="searchStudent">
                                            <i class="bi bi-search"></i> بحث
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="studentInfo" class="student-info" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5><i class="bi bi-person"></i> معلومات الطالب</h5>
                                        <p><strong>الاسم:</strong> <span id="displayName"></span></p>
                                        <p><strong>الصف:</strong> <span id="displayGrade"></span></p>
                                        <p><strong>رقم البطاقة:</strong> <span id="displayCard"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="payment-history">
                                            <h5><i class="bi bi-clock-history"></i> سجل الدفع</h5>
                                            <div id="paymentHistory" class="history-items">
                                                <!-- Payment history will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card payment-card animate__animated animate__fadeIn">
                        <div class="card-header">
                            <h4><i class="bi bi-cash-stack"></i> عملية الدفع</h4>
                        </div>
                        <div class="card-body">
                            <form id="paymentForm">
                                <div class="mb-3">
                                    <label for="paymentPurpose" class="form-label">الغرض من الدفع</label>
                                    <select class="form-select" id="paymentPurpose" required>
                                        <option value="" selected disabled>اختر الغرض</option>
                                        <option value="الرسوم الدراسية">الرسوم الدراسية</option>
                                        <option value="الزي المدرسي">الزي المدرسي</option>
                                        <option value="الكتب الدراسية">الكتب الدراسية</option>
                                        <option value="النشاطات">النشاطات</option>
                                        <option value="أخرى">أخرى</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="paymentAmount" class="form-label">المبلغ (ج.م)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">ج.م</span>
                                        <input type="number" class="form-control" id="paymentAmount" min="1" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="paymentNotes" class="form-label">ملاحظات</label>
                                    <textarea class="form-control" id="paymentNotes" rows="2"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary w-100" id="submitPayment">
                                    <i class="bi bi-check-circle"></i> تأكيد الدفع
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="paymentToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-success text-white">
                    <strong class="me-auto"><i class="bi bi-check-circle"></i> تم بنجاح</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastMessage">
                    تم تسجيل الدفع بنجاح!
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyC2xr8NaXeiYuwJQa7k6qHllRY0tiBcfh8",
    authDomain: "card-bcf12.firebaseapp.com",
    projectId: "card-bcf12",
    storageBucket: "card-bcf12.appspot.com",
    messagingSenderId: "482725905996",
    appId: "1:482725905996:web:a1eec0ac4730da8edfd6e9",
    measurementId: "G-46JJKN96ZE"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Enable offline persistence
db.enablePersistence()
  .catch((err) => {
      if (err.code == 'failed-precondition') {
          console.log("Offline persistence can only be enabled in one tab at a time.");
      } else if (err.code == 'unimplemented') {
          console.log("The current browser does not support offline persistence.");
      }
  });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    // Initialize elements
    const searchStudentBtn = document.getElementById('searchStudent');
    const searchCodeInput = document.getElementById('searchCode');
    const studentInfoDiv = document.getElementById('studentInfo');
    const paymentForm = document.getElementById('paymentForm');
    const submitPaymentBtn = document.getElementById('submitPayment');
    const paymentHistoryDiv = document.getElementById('paymentHistory');
    const paymentToast = new bootstrap.Toast(document.getElementById('paymentToast'));
    const toastMessage = document.getElementById('toastMessage');

    let currentStudentId = '';
    let currentStudentData = null;

    // Search for student
    searchStudentBtn.addEventListener('click', async function() {
        const studentCode = searchCodeInput.value.trim();
        
        if (!studentCode) {
            showError('يرجى إدخال كود الطالب');
            return;
        }

        searchStudentBtn.disabled = true;
        searchStudentBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> جاري البحث...';

        try {
            const doc = await db.collection('students').doc(studentCode).get();
            
            if (doc.exists) {
                currentStudentData = doc.data();
                currentStudentId = studentCode;
                
                // Display student info
                document.getElementById('displayName').textContent = currentStudentData.studentName;
                document.getElementById('displayGrade').textContent = currentStudentData.studentGrade;
                document.getElementById('displayCard').textContent = currentStudentData.cardNumber;
                
                // Load payment history
                await loadPaymentHistory(currentStudentData.payments || []);
                
                // Show elements
                studentInfoDiv.style.display = 'block';
                paymentForm.style.display = 'block';
                
                // Highlight found student
                studentInfoDiv.classList.add('animate__animated', 'animate__pulse');
                setTimeout(() => {
                    studentInfoDiv.classList.remove('animate__animated', 'animate__pulse');
                }, 1000);
            } else {
                showError('لا يوجد طالب بهذا الكود');
                studentInfoDiv.style.display = 'none';
            }
        } catch (error) {
            console.error('Error searching for student:', error);
            showError('حدث خطأ أثناء البحث عن الطالب');
        } finally {
            searchStudentBtn.disabled = false;
            searchStudentBtn.innerHTML = '<i class="bi bi-search"></i> بحث';
        }
    });

    // Load payment history
    async function loadPaymentHistory(payments) {
        paymentHistoryDiv.innerHTML = '';
        
        if (payments.length === 0) {
            paymentHistoryDiv.innerHTML = '<div class="alert alert-info">لا توجد مدفوعات سابقة</div>';
            return;
        }
        
        // Sort by date (newest first)
        payments.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Display payments
        payments.forEach(payment => {
            const paymentDate = new Date(payment.date).toLocaleString('ar-EG');
            const paymentItem = document.createElement('div');
            paymentItem.className = 'history-item';
            paymentItem.innerHTML = `
                <div class="item-header">
                    <span class="purpose">${payment.purpose}</span>
                    <span class="amount">${payment.amount} ج.م</span>
                </div>
                <div class="item-details">
                    <span class="date">${paymentDate}</span>
                    ${payment.notes ? `<span class="notes">${payment.notes}</span>` : ''}
                </div>
            `;
            paymentHistoryDiv.appendChild(paymentItem);
        });
    }

    // Submit payment
    paymentForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!currentStudentId) {
            showError('يرجى البحث عن الطالب أولاً');
            return;
        }

        const purpose = document.getElementById('paymentPurpose').value;
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        const notes = document.getElementById('paymentNotes').value;

        if (!purpose || !amount) {
            showError('يرجى إدخال الغرض والمبلغ');
            return;
        }

        submitPaymentBtn.disabled = true;
        submitPaymentBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> جاري التسجيل...';

        const paymentData = {
            purpose,
            amount,
            date: new Date().toISOString(),
            processedBy: 'مسؤول النظام'
        };

        if (notes) {
            paymentData.notes = notes;
        }

        try {
            // Add payment to student's document
            await db.collection('students').doc(currentStudentId).update({
                payments: firebase.firestore.FieldValue.arrayUnion(paymentData)
            });

            // Update UI
            if (currentStudentData.payments) {
                currentStudentData.payments.push(paymentData);
            } else {
                currentStudentData.payments = [paymentData];
            }
            
            await loadPaymentHistory(currentStudentData.payments);
            
            // Show success message
            toastMessage.textContent = `تم تسجيل دفع ${amount} ج.م للغرض ${purpose}`;
            paymentToast.show();
            
            // Reset form
            paymentForm.reset();
        } catch (error) {
            console.error('Error submitting payment:', error);
            showError('حدث خطأ أثناء تسجيل الدفع: ' + error.message);
        } finally {
            submitPaymentBtn.disabled = false;
            submitPaymentBtn.innerHTML = '<i class="bi bi-check-circle"></i> تأكيد الدفع';
        }
    });

    // Helper function to show error messages
    function showError(message) {
        toastMessage.textContent = message;
        paymentToast._element.querySelector('.toast-header').className = 'toast-header bg-danger text-white';
        paymentToast.show();
        
        // Reset to success style after showing
        setTimeout(() => {
            paymentToast._element.querySelector('.toast-header').className = 'toast-header bg-success text-white';
        }, 5000);
    }
});
    </script>
</body>
</html>