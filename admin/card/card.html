<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام البطاقات الطلابية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<style>
    :root {
    --primary-color: #4361ee;
    --secondary-color: #3f37c9;
    --accent-color: #4895ef;
    --dark-color: #1b263b;
    --light-color: #f8f9fa;
    --success-color: #4cc9f0;
    --danger-color: #f72585;
    --warning-color: #f8961e;
}

body {
    font-family: 'Tajawal', sans-serif;
    background-color: #f5f7fa;
    color: #333;
}

/* Sidebar Styles */
.sidebar {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 250px;
    background-color: var(--dark-color);
    color: white;
    padding: 20px 0;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    transition: all 0.3s;
}

.sidebar-header {
    padding: 0 20px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar-menu {
    list-style: none;
    padding: 0;
    margin: 0;
}

.sidebar-menu li {
    padding: 10px 20px;
    transition: all 0.3s;
}

.sidebar-menu li a {
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    display: block;
    transition: all 0.3s;
}

.sidebar-menu li a:hover {
    color: white;
    transform: translateX(-5px);
}

.sidebar-menu li.active {
    background-color: rgba(255, 255, 255, 0.1);
    border-right: 3px solid var(--accent-color);
}

.sidebar-menu li.active a {
    color: white;
}

.sidebar-menu i {
    margin-left: 10px;
}

/* Main Content Styles */
.main-content {
    margin-right: 250px;
    padding: 20px;
    min-height: 100vh;
}

.navbar {
    background-color: white;
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.navbar-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--dark-color);
}

.navbar-user {
    display: flex;
    align-items: center;
}

.user-avatar {
    width: 40px;
    border-radius: 50%;
    margin-left: 10px;
}

/* Card Styles */
.card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 20px;
    transition: all 0.3s;
}

.card:hover {
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
}

.card-header {
    background-color: white;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    padding: 15px 20px;
    border-radius: 10px 10px 0 0 !important;
    font-weight: bold;
}

.card-body {
    padding: 20px;
}

/* Form Styles */
.form-label {
    font-weight: 600;
    margin-bottom: 8px;
}

.form-control, .form-select {
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    transition: all 0.3s;
}

.form-control:focus, .form-select:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
}

.input-group-text {
    background-color: #f8f9fa;
    border-radius: 8px 0 0 8px;
}

/* Student Info Styles */
.student-info {
    background-color: #f8fafc;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid var(--primary-color);
    margin-top: 20px;
}

.student-info h5 {
    color: var(--primary-color);
    margin-bottom: 15px;
}

.student-info p {
    margin-bottom: 10px;
}

.student-info strong {
    color: var(--dark-color);
    margin-left: 5px;
}

/* Payment History Styles */
.payment-history {
    background-color: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.history-item {
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.history-item:last-child {
    border-bottom: none;
}

.item-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.purpose {
    font-weight: bold;
    color: var(--dark-color);
}

.amount {
    font-weight: bold;
    color: var(--primary-color);
}

.item-details {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    color: #666;
}

/* Payment Card Styles */
.payment-card {
    background-color: #f8fafc;
    border: 1px solid #e2e8f0;
}

.payment-card .card-header {
    background-color: transparent;
}

/* Button Styles */
.btn-primary {
    background-color: var(--primary-color);
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    transition: all 0.3s;
}

.btn-primary:hover {
    background-color: var(--secondary-color);
    transform: translateY(-2px);
}

.btn-outline-primary {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.btn-outline-primary:hover {
    background-color: var(--primary-color);
}

/* Toast Styles */
.toast {
    border-radius: 8px;
    border: none;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

/* Responsive Styles */
@media (max-width: 992px) {
    .sidebar {
        width: 70px;
        overflow: hidden;
    }
    
    .sidebar-header h3 {
        display: none;
    }
    
    .sidebar-menu li a span {
        display: none;
    }
    
    .sidebar-menu li a i {
        margin-left: 0;
        font-size: 1.2rem;
    }
    
    .main-content {
        margin-right: 70px;
    }
}

@media (max-width: 768px) {
    .sidebar {
        display: none;
    }
    
    .main-content {
        margin-right: 0;
    }
}
</style>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-card-heading"></i> نظام البطاقات</h3>
        </div>
        <ul class="sidebar-menu">
            <li class="active"><a href="card.html"><i class="bi bi-person-plus"></i> إنشاء بطاقة</a></li>
            <li><a href="payment.html"><i class="bi bi-cash-coin"></i> الدفع</a></li>
            <li><a href="#"><i class="bi bi-search"></i> البحث</a></li>
            <li><a href="#"><i class="bi bi-gear"></i> الإعدادات</a></li>
        </ul>
    </div>

    <div class="main-content">
        <nav class="navbar">
            <div class="navbar-title">إنشاء بطاقة طالب جديدة</div>
            <div class="navbar-user">
                <img src="logo.png" alt="User" class="user-avatar">
                <span>مسؤول النظام</span>
            </div>
        </nav>

        <div class="content-container">
            <div class="card animate__animated animate__fadeIn">
                <div class="card-header">
                    <h4><i class="bi bi-person-badge"></i> بيانات الطالب</h4>
                </div>
                <div class="card-body">
                    <form id="studentForm" class="needs-validation" novalidate>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="studentName" class="form-label">اسم الطالب كاملًا</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <input type="text" class="form-control" id="studentName" required>
                                    <div class="invalid-feedback">يرجى إدخال اسم الطالب</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="studentCode" class="form-label">كود الطالب</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-123"></i></span>
                                    <input type="text" class="form-control" id="studentCode" required>
                                    <div class="invalid-feedback">يرجى إدخال كود الطالب</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="studentGrade" class="form-label">الصف الدراسي</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-book"></i></span>
                                    <select class="form-select" id="studentGrade" required>
                                        <option value="" selected disabled>اختر الصف</option>
                                        <option value="الأول الثانوي">الأول الثانوي</option>
                                        <option value="الثاني الثانوي">الثاني الثانوي</option>
                                        <option value="الثالث الثانوي">الثالث الثانوي</option>
                                    </select>
                                    <div class="invalid-feedback">يرجى اختيار الصف</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phoneNumber" class="form-label">رقم الهاتف</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-phone"></i></span>
                                    <input type="tel" class="form-control" id="phoneNumber" required>
                                    <div class="invalid-feedback">يرجى إدخال رقم الهاتف</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="cardNumber" class="form-label">رقم البطاقة</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-credit-card"></i></span>
                                    <input type="text" class="form-control" id="cardNumber" readonly>
                                    <button type="button" class="btn btn-outline-primary" id="generateCard">
                                        <i class="bi bi-shuffle"></i> توليد رقم البطاقة
                                    </button>
                                    <div class="invalid-feedback">يرجى توليد رقم البطاقة</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="reset" class="btn btn-secondary me-md-2">
                                <i class="bi bi-x-circle"></i> إلغاء
                            </button>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="bi bi-save"></i> حفظ البيانات
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="toast-container position-fixed bottom-0 end-0 p-3">
                <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-success text-white">
                        <strong class="me-auto"><i class="bi bi-check-circle"></i> تم بنجاح</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        تم حفظ بيانات الطالب بنجاح!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyC2xr8NaXeiYuwJQa7k6qHllRY0tiBcfh8",
    authDomain: "card-bcf12.firebaseapp.com",
    projectId: "card-bcf12",
    storageBucket: "card-bcf12.appspot.com",
    messagingSenderId: "482725905996",
    appId: "1:482725905996:web:a1eec0ac4730da8edfd6e9",
    measurementId: "G-46JJKN96ZE"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Enable offline persistence
db.enablePersistence()
  .catch((err) => {
      if (err.code == 'failed-precondition') {
          console.log("Offline persistence can only be enabled in one tab at a time.");
      } else if (err.code == 'unimplemented') {
          console.log("The current browser does not support offline persistence.");
      }
  });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    // Initialize form validation
    const form = document.getElementById('studentForm');
    const generateCardBtn = document.getElementById('generateCard');
    const cardNumberInput = document.getElementById('cardNumber');
    const submitBtn = document.getElementById('submitBtn');
    const successToast = new bootstrap.Toast(document.getElementById('successToast'));

    // Generate card number with Luhn algorithm
    generateCardBtn.addEventListener('click', async function() {
        submitBtn.disabled = true;
        generateCardBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> جاري التوليد...';
        
        try {
            const cardNumber = await generateUniqueCardNumber();
            cardNumberInput.value = cardNumber;
            cardNumberInput.classList.add('is-valid');
        } catch (error) {
            console.error('Error generating card number:', error);
            alert('حدث خطأ أثناء توليد رقم البطاقة');
        } finally {
            generateCardBtn.innerHTML = '<i class="bi bi-shuffle"></i> توليد رقم البطاقة';
            submitBtn.disabled = false;
        }
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (!form.checkValidity() || !cardNumberInput.value) {
            if (!cardNumberInput.value) {
                cardNumberInput.classList.add('is-invalid');
            }
            form.classList.add('was-validated');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> جاري الحفظ...';

        const studentData = {
            studentName: document.getElementById('studentName').value,
            studentCode: document.getElementById('studentCode').value,
            studentGrade: document.getElementById('studentGrade').value,
            phoneNumber: document.getElementById('phoneNumber').value,
            cardNumber: cardNumberInput.value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            payments: []
        };

        try {
            // Check if student code exists
            const docRef = db.collection('students').doc(studentData.studentCode);
            const doc = await docRef.get();
            
            if (doc.exists) {
                alert('كود الطالب موجود بالفعل!');
                return;
            }

            // Save to Firestore
            await docRef.set(studentData);
            
            // Show success message
            successToast.show();
            
            // Reset form
            form.reset();
            form.classList.remove('was-validated');
            cardNumberInput.value = '';
            cardNumberInput.classList.remove('is-valid');
        } catch (error) {
            console.error('Error saving student:', error);
            alert('حدث خطأ أثناء حفظ البيانات: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-save"></i> حفظ البيانات';
        }
    });

    // Generate unique card number with retry logic
    async function generateUniqueCardNumber() {
        let attempts = 0;
        const maxAttempts = 5;
        
        while (attempts < maxAttempts) {
            const cardNumber = generateCardNumber();
            const querySnapshot = await db.collection('students')
                .where('cardNumber', '==', cardNumber)
                .limit(1)
                .get();
                
            if (querySnapshot.empty) {
                return cardNumber;
            }
            
            attempts++;
        }
        
        throw new Error('فشل في توليد رقم بطاقة فريد بعد عدة محاولات');
    }

    // Luhn algorithm implementation
    function generateCardNumber() {
        let cardNumber = '';
        const digits = '0123456789';
        
        // Generate first 13 digits
        for (let i = 0; i < 13; i++) {
            cardNumber += digits.charAt(Math.floor(Math.random() * digits.length));
        }
        
        // Calculate Luhn check digit
        let sum = 0;
        for (let i = 0; i < 13; i++) {
            let digit = parseInt(cardNumber.charAt(i));
            
            if (i % 2 === 0) { // Double every other digit
                digit *= 2;
                if (digit > 9) digit -= 9;
            }
            
            sum += digit;
        }
        
        const checkDigit = (10 - (sum % 10)) % 10;
        return cardNumber + checkDigit.toString();
    }
});
    </script>


<Script>
    const functions = require('firebase-functions');
const admin = require('firebase-admin');
admin.initializeApp();

exports.disableExpiredCards = functions.pubsub.schedule('every 24 hours').onRun(async (context) => {
    const now = new Date();
    const cardsRef = admin.firestore().collection('magneticCards');
    const snapshot = await cardsRef
        .where('expiresAt', '<=', now)
        .where('isActive', '==', true)
        .get();

    const batch = admin.firestore().batch();
    
    snapshot.forEach(doc => {
        batch.update(doc.ref, {
            status: 'expired',
            isActive: false
        });
    });

    await batch.commit();
    console.log(`Disabled ${snapshot.size} expired cards.`);
    return null;
});
</Script>
</body>
</html>