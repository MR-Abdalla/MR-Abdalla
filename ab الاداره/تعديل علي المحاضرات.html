<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>إدارة المحاضرات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0a3a8d;
      --primary-dark: #072b6f;
      --secondary: #34a853;
      --secondary-dark: #2a8a43;
      --light: #f5f7fb;
      --white: #ffffff;
      --text: #333333;
      --text-light: #666666;
      --border: #e1e5ee;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.12);
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Cairo", sans-serif;
      direction: rtl;
      background: linear-gradient(135deg, #f5f7fb 0%, #eef3ff 100%);
      margin: 0;
      padding: 20px;
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    h1 {
      color: var(--primary);
      margin: 0;
      font-size: 2.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    h1::before {
      content: "🛠️";
    }

    .subtitle {
      color: var(--text-light);
      margin-top: 8px;
      font-size: 1.1rem;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-box input {
      padding-right: 40px;
    }

    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }

    .filter-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
      font-family: inherit;
      font-size: 0.95rem;
      min-width: 150px;
    }

    .videos-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 25px;
    }

    .video-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .video-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    .video-card::before {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 5px;
      height: 100%;
      background: var(--primary);
    }

    .video-thumbnail {
      position: relative;
      margin-bottom: 15px;
    }

    .video-thumbnail img {
      width: 100%;
      border-radius: 10px;
      display: block;
      transition: var(--transition);
    }

    .video-thumbnail:hover img {
      transform: scale(1.02);
    }

    .video-overlay {
      position: absolute;
      bottom: 0;
      right: 0;
      left: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
      padding: 15px 10px 5px;
      border-radius: 0 0 10px 10px;
    }

    .video-title {
      color: var(--white);
      font-weight: 600;
      font-size: 1.1rem;
      margin: 0;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
      font-size: 0.95rem;
    }

    input, textarea, select {
      width: 100%;
      margin: 0;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-family: inherit;
      font-size: 0.95rem;
      transition: var(--transition);
      background: var(--light);
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(10, 58, 141, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .meta-info {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
      padding: 12px;
      background: var(--light);
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .price-tag {
      background: var(--primary);
      color: var(--white);
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .date-added {
      color: var(--text-light);
    }

    details {
      background: #f0f5ff;
      border-radius: 8px;
      margin: 15px 0;
      overflow: hidden;
      transition: var(--transition);
    }

    details[open] {
      background: #e8efff;
    }

    summary {
      font-weight: 600;
      padding: 12px 15px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    summary:hover {
      background: rgba(10, 58, 141, 0.05);
    }

    summary::marker {
      color: var(--primary);
    }

    .details-content {
      padding: 15px;
      border-top: 1px solid var(--border);
    }

    .extra-lecture, .quiz-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px dashed var(--border);
      position: relative;
    }

    .extra-lecture:last-child, .quiz-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .delete-btn {
      position: absolute;
      left: 0;
      top: 0;
      background: #ff4d4d;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
    }

    .quiz-img {
      width: 100%;
      border-radius: 8px;
      margin: 8px 0;
      border: 1px solid var(--border);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      font-family: inherit;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .save-btn {
      background: var(--primary);
      color: var(--white);
      width: 100%;
      margin-top: 10px;
    }

    .save-btn:hover {
      background: var(--primary-dark);
    }

    .sub-btn {
      background: var(--secondary);
      color: var(--white);
      padding: 8px 12px;
      font-size: 0.9rem;
    }

    .sub-btn:hover {
      background: var(--secondary-dark);
    }

    .add-btn-container {
      text-align: center;
      margin-top: 10px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.1rem;
      color: var(--text-light);
    }

    .loading::after {
      content: "";
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateX(150%);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--secondary);
    }

    .notification.error {
      background: #ff4d4d;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-light);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .videos-container {
        grid-template-columns: 1fr;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .container {
        padding: 0 10px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-group {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>إدارة جميع المحاضرات</h1>
      <p class="subtitle">قم بتعديل وإدارة محتوى المحاضرات والاختبارات بسهولة</p>
    </header>
    
    <div class="controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ابحث في المحاضرات...">
        <span class="search-icon">🔍</span>
      </div>
      <div class="filter-group">
        <select id="gradeFilter" class="filter-select">
          <option value="">جميع الصفوف</option>
          <option value="1">أولى ثانوي</option>
          <option value="2">تانية ثانوي</option>
          <option value="3">تالتة ثانوي</option>
        </select>
        <select id="sortFilter" class="filter-select">
          <option value="newest">الأحدث أولاً</option>
          <option value="oldest">الأقدم أولاً</option>
          <option value="price-high">الأعلى سعراً</option>
          <option value="price-low">الأقل سعراً</option>
        </select>
      </div>
    </div>
    
    <div id="videosContainer" class="videos-container">
      <div class="loading">جاري تحميل البيانات...</div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // 🔧 إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBaezH8j4u0Kmum3poYuFk8LsGtVietnSM",
      authDomain: "viduo-corss.firebaseapp.com",
      projectId: "viduo-corss",
      storageBucket: "viduo-corss.firebasestorage.app",
      messagingSenderId: "485896854659",
      appId: "1:485896854659:web:f0a618235eb4d9e9784fb6",
      measurementId: "G-SVB0WMS9MW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allVideos = [];

    // 🧠 تحميل المحاضرات
    async function loadVideos() {
      const container = document.getElementById("videosContainer");
      container.innerHTML = '<div class="loading">جاري تحميل البيانات...</div>';

      try {
        const snapshot = await getDocs(collection(db, "videos"));
        container.innerHTML = "";
        allVideos = [];

        if (snapshot.empty) {
          container.innerHTML = '<div class="empty-state">لا توجد محاضرات لعرضها</div>';
          return;
        }

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const id = docSnap.id;
          
          allVideos.push({
            id,
            ...data
          });
        });

        displayVideos(allVideos);
      } catch (error) {
        console.error("Error loading videos:", error);
        container.innerHTML = '<div class="empty-state">حدث خطأ في تحميل البيانات</div>';
      }
    }

    // عرض المحاضرات
    function displayVideos(videos) {
      const container = document.getElementById("videosContainer");
      container.innerHTML = "";

      if (videos.length === 0) {
        container.innerHTML = '<div class="empty-state">لا توجد محاضرات تطابق معايير البحث</div>';
        return;
      }

      videos.forEach((video) => {
        const { id, title, description, grade, link, image, price, createdAt, extraLectures, quiz } = video;

        const formattedDate = createdAt
          ? new Date(createdAt.seconds * 1000).toLocaleString("ar-EG")
          : "غير متوفر";

        const card = document.createElement("div");
        card.className = "video-card";

        card.innerHTML = `
          <div class="video-thumbnail">
            <img src="${image}" alt="${title}" onerror="this.src='https://via.placeholder.com/400x225?text=صورة+غير+متوفرة'">
            <div class="video-overlay">
              <h3 class="video-title">${title || "بدون عنوان"}</h3>
            </div>
          </div>
          
          <div class="form-group">
            <label for="title-${id}">عنوان المحاضرة:</label>
            <input type="text" id="title-${id}" value="${title}" placeholder="أدخل عنوان المحاضرة">
          </div>
          
          <div class="form-group">
            <label for="desc-${id}">الوصف:</label>
            <textarea id="desc-${id}" rows="2" placeholder="أدخل وصف المحاضرة">${description || ""}</textarea>
          </div>
          
          <div class="form-group">
            <label for="grade-${id}">الصف الدراسي:</label>
            <select id="grade-${id}">
              <option value="1" ${grade==="1"?"selected":""}>أولى ثانوي</option>
              <option value="2" ${grade==="2"?"selected":""}>تانية ثانوي</option>
              <option value="3" ${grade==="3"?"selected":""}>تالتة ثانوي</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="link-${id}">رابط الفيديو:</label>
            <input type="url" id="link-${id}" value="${link}" placeholder="https://example.com/video">
          </div>
          
          <div class="form-group">
            <label for="image-${id}">رابط الصورة:</label>
            <input type="url" id="image-${id}" value="${image}" placeholder="https://example.com/image.jpg">
          </div>
          
          <div class="form-group">
            <label for="price-${id}">السعر (جنيه):</label>
            <input type="number" id="price-${id}" value="${price}" min="0" step="0.01">
          </div>
          
          <div class="meta-info">
            <span class="price-tag">${price || 0} جنيه</span>
            <span class="date-added">${formattedDate}</span>
          </div>

          <details>
            <summary>📘 المحاضرات الإضافية (${(extraLectures || []).length})</summary>
            <div class="details-content" id="extra-${id}">
              ${(extraLectures || []).map((ex, i)=>`
                <div class="extra-lecture">
                  <button class="delete-btn" onclick="deleteExtra('${id}', ${i})">×</button>
                  <input type="text" placeholder="عنوان المحاضرة الإضافية" id="extra-title-${id}-${i}" value="${ex.title||""}">
                  <input type="url" placeholder="رابط المحاضرة الإضافية" id="extra-link-${id}-${i}" value="${ex.link||""}">
                </div>
              `).join("")}
              <div class="add-btn-container">
                <button class="btn sub-btn" onclick="addExtra('${id}')">➕ إضافة محاضرة إضافية</button>
              </div>
            </div>
          </details>

          <details>
            <summary>🧠 الأسئلة (${(quiz || []).length})</summary>
            <div class="details-content" id="quiz-${id}">
              ${(quiz || []).map((q, i)=>`
                <div class="quiz-item">
                  <button class="delete-btn" onclick="deleteQuiz('${id}', ${i})">×</button>
                  <img class="quiz-img" src="${q.image}" alt="سؤال ${q.number}" onerror="this.src='https://via.placeholder.com/400x200?text=صورة+السؤال'">
                  <input type="url" placeholder="رابط صورة السؤال" id="quiz-img-${id}-${i}" value="${q.image}">
                  <input type="number" placeholder="رقم السؤال" id="quiz-num-${id}-${i}" value="${q.number}">
                  <input type="text" placeholder="الإجابة الصحيحة" id="quiz-correct-${id}-${i}" value="${q.correctAnswer}">
                </div>
              `).join("")}
              <div class="add-btn-container">
                <button class="btn sub-btn" onclick="addQuiz('${id}')">➕ إضافة سؤال جديد</button>
              </div>
            </div>
          </details>

          <button class="btn save-btn" onclick="saveVideo('${id}')">💾 حفظ التعديلات</button>
        `;

        container.appendChild(card);
      });
    }

    // 💾 حفظ التعديلات
    window.saveVideo = async function(id) {
      try {
        const title = document.getElementById(`title-${id}`).value;
        const desc = document.getElementById(`desc-${id}`).value;
        const grade = document.getElementById(`grade-${id}`).value;
        const link = document.getElementById(`link-${id}`).value;
        const image = document.getElementById(`image-${id}`).value;
        const price = Number(document.getElementById(`price-${id}`).value);

        // جمع المحاضرات الإضافية
        const extraInputs = document.querySelectorAll(`[id^="extra-title-${id}-"]`);
        const extraLectures = [];
        extraInputs.forEach((input, index) => {
          const title = input.value;
          const link = document.getElementById(`extra-link-${id}-${index}`).value;
          if (title || link) {
            extraLectures.push({ title, link });
          }
        });

        // جمع الأسئلة
        const quizImgInputs = document.querySelectorAll(`[id^="quiz-img-${id}-"]`);
        const quiz = [];
        quizImgInputs.forEach((input, index) => {
          const image = input.value;
          const number = document.getElementById(`quiz-num-${id}-${index}`).value;
          const correctAnswer = document.getElementById(`quiz-correct-${id}-${index}`).value;
          if (image || number || correctAnswer) {
            quiz.push({ image, number, correctAnswer });
          }
        });

        const videoRef = doc(db, "videos", id);
        await updateDoc(videoRef, { 
          title, 
          description: desc, 
          grade, 
          link, 
          image, 
          price,
          extraLectures,
          quiz
        });
        
        showNotification("✅ تم حفظ التعديلات بنجاح", "success");
      } catch (error) {
        console.error("Error saving video:", error);
        showNotification("❌ حدث خطأ أثناء حفظ التعديلات", "error");
      }
    }

    // ➕ إضافة محاضرة إضافية
    window.addExtra = function(id) {
      const extraDiv = document.getElementById(`extra-${id}`);
      const count = extraDiv.querySelectorAll(".extra-lecture").length;
      const html = `
        <div class="extra-lecture">
          <button class="delete-btn" onclick="deleteExtra('${id}', ${count})">×</button>
          <input type="text" placeholder="عنوان المحاضرة الإضافية" id="extra-title-${id}-${count}">
          <input type="url" placeholder="رابط المحاضرة الإضافية" id="extra-link-${id}-${count}">
        </div>`;
      
      // إدراج قبل زر الإضافة
      const addButton = extraDiv.querySelector(".add-btn-container");
      addButton.insertAdjacentHTML("beforebegin", html);
    }

    // ➕ إضافة سؤال جديد
    window.addQuiz = function(id) {
      const quizDiv = document.getElementById(`quiz-${id}`);
      const count = quizDiv.querySelectorAll(".quiz-item").length;
      const html = `
        <div class="quiz-item">
          <button class="delete-btn" onclick="deleteQuiz('${id}', ${count})">×</button>
          <input type="url" placeholder="رابط صورة السؤال" id="quiz-img-${id}-${count}">
          <input type="number" placeholder="رقم السؤال" id="quiz-num-${id}-${count}">
          <input type="text" placeholder="الإجابة الصحيحة" id="quiz-correct-${id}-${count}">
        </div>`;
      
      // إدراج قبل زر الإضافة
      const addButton = quizDiv.querySelector(".add-btn-container");
      addButton.insertAdjacentHTML("beforebegin", html);
    }

    // 🗑️ حذف محاضرة إضافية
    window.deleteExtra = function(id, index) {
      const extraDiv = document.getElementById(`extra-${id}`);
      const extraItems = extraDiv.querySelectorAll(".extra-lecture");
      
      if (extraItems.length > index) {
        extraItems[index].remove();
      }
    }

    // 🗑️ حذف سؤال
    window.deleteQuiz = function(id, index) {
      const quizDiv = document.getElementById(`quiz-${id}`);
      const quizItems = quizDiv.querySelectorAll(".quiz-item");
      
      if (quizItems.length > index) {
        quizItems[index].remove();
      }
    }

    // 🔔 عرض الإشعارات
    function showNotification(message, type) {
      const notification = document.getElementById("notification");
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove("show");
      }, 3000);
    }

    // 🔍 البحث والتصفية
    function setupFilters() {
      const searchInput = document.getElementById("searchInput");
      const gradeFilter = document.getElementById("gradeFilter");
      const sortFilter = document.getElementById("sortFilter");
      
      function applyFilters() {
        let filteredVideos = [...allVideos];
        
        // التصفية حسب البحث
        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
          filteredVideos = filteredVideos.filter(video => 
            video.title?.toLowerCase().includes(searchTerm) || 
            video.description?.toLowerCase().includes(searchTerm)
          );
        }
        
        // التصفية حسب الصف
        const gradeValue = gradeFilter.value;
        if (gradeValue) {
          filteredVideos = filteredVideos.filter(video => video.grade === gradeValue);
        }
        
        // الترتيب
        const sortValue = sortFilter.value;
        switch(sortValue) {
          case "newest":
            filteredVideos.sort((a, b) => {
              const aTime = a.createdAt?.seconds || 0;
              const bTime = b.createdAt?.seconds || 0;
              return bTime - aTime;
            });
            break;
          case "oldest":
            filteredVideos.sort((a, b) => {
              const aTime = a.createdAt?.seconds || 0;
              const bTime = b.createdAt?.seconds || 0;
              return aTime - bTime;
            });
            break;
          case "price-high":
            filteredVideos.sort((a, b) => (b.price || 0) - (a.price || 0));
            break;
          case "price-low":
            filteredVideos.sort((a, b) => (a.price || 0) - (b.price || 0));
            break;
        }
        
        displayVideos(filteredVideos);
      }
      
      searchInput.addEventListener("input", applyFilters);
      gradeFilter.addEventListener("change", applyFilters);
      sortFilter.addEventListener("change", applyFilters);
    }

    // 📱 إعادة التحميل عند العودة بعد فترة
    let leaveTime = null;

    window.addEventListener("blur", () => {
      leaveTime = Date.now();
    });

    window.addEventListener("focus", () => {
      if (leaveTime) {
        const now = Date.now();
        const diffMinutes = (now - leaveTime) / 60000;

        if (diffMinutes > 5) {
          location.reload();
        }
      }
    });

    // تهيئة الصفحة
    loadVideos().then(() => {
      setupFilters();
    });
  </script>
</body>
</html>