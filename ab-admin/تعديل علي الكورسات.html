<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إضافة محاضرات للكورسات</title>
  <style>
    body {
      font-family: Arial;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      margin: auto;
      box-shadow: 0 0 10px #ccc;
    }
    input, select, button, textarea {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #999;
    }
    .images-container input { margin-bottom: 6px; }
  </style>
</head>
<body>

<div class="container">
  <h2>إضافة محاضرة جديدة للكورس</h2>

  <!-- اختيار الكورس -->
  <label>اختار الكورس:</label>
  <select id="courseSelect"></select>

  <hr>

  <h3>بيانات المحاضرة</h3>

  <input type="text" id="lectureTitle" placeholder="عنوان المحاضرة">

  <input type="text" id="videoLink" placeholder="لينك فيديو المحاضرة">

  <input type="text" id="homeworkLink" placeholder="لينك واجب المحاضرة">

  <input type="text" id="pdfLink" placeholder="لينك PDF (اختياري)">

  <label>عدد الصور:</label>
  <input type="number" id="imageCount" min="0" value="0">

  <div id="imagesInputs" class="images-container"></div>

  <button onclick="saveLecture()">حفظ المحاضرة</button>

  <p id="status" style="color:green;"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { 
  getFirestore, doc, getDocs, collection, updateDoc 
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCC5aNDvRjMZFle2tFp3vY6kb74kjVp7Dg",
  authDomain: "subscriptions-f84ee.firebaseapp.com",
  projectId: "subscriptions-f84ee",
  storageBucket: "subscriptions-f84ee.firebasestorage.app",
  messagingSenderId: "425125909485",
  appId: "1:425125909485:web:1dcdf4989d35e5e53c8de4",
  measurementId: "G-B6X1XTLM6Q"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// تحميل الكورسات إلى القائمة
async function loadCourses() {
  const courseSelect = document.getElementById("courseSelect");
  const querySnapshot = await getDocs(collection(db, "courses"));

  querySnapshot.forEach((course) => {
    const option = document.createElement("option");
    option.value = course.id;
    option.textContent = course.data().title;
    courseSelect.appendChild(option);
  });
}
loadCourses();

// إنشاء حقول الصور
document.getElementById("imageCount").addEventListener("change", () => {
  const num = Number(document.getElementById("imageCount").value);
  const container = document.getElementById("imagesInputs");
  container.innerHTML = "";

  for (let i = 0; i < num; i++) {
    const input = document.createElement("input");
    input.placeholder = `رابط الصورة ${i + 1}`;
    input.className = "imageInput";
    container.appendChild(input);
  }
});

// حفظ المحاضرة
async function saveLecture() {
  const courseId = document.getElementById("courseSelect").value;
  const title = document.getElementById("lectureTitle").value;
  const videoLink = document.getElementById("videoLink").value;
  const homeworkVideo = document.getElementById("homeworkLink").value;
  const pdfLink = document.getElementById("pdfLink").value;

  const images = [...document.querySelectorAll(".imageInput")].map(el => el.value);

  const courseRef = doc(db, "courses", courseId);
  const courseSnap = await getDocs(collection(db, "courses"));

  let lectures = [];

  courseSnap.forEach((c) => {
    if (c.id === courseId) {
      lectures = c.data().lectures || [];
    }
  });

  // إضافة محاضرة جديدة
  lectures.push({
    title,
    videoLink,
    homeworkVideo,
    pdfLink: pdfLink || null,
    images: images,
    number: lectures.length + 1
  });

  // تحديث قاعدة البيانات
  await updateDoc(courseRef, {
    lectures: lectures,
    totalLectures: lectures.length,
    updatedAt: new Date().toISOString()
  });

  document.getElementById("status").textContent = "تم حفظ المحاضرة بنجاح ✔️";
}

window.saveLecture = saveLecture;

</script>

</body>
</html>
