<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الامتحانات الإلكترونية</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --card-bg: #0f3460;
            --text-color: #e6e6e6;
            --accent-color: #00b4d8;
            --danger-color: #e94560;
            --success-color: #4cc9f0;
            --border-radius: 12px;
            --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            text-align: center;
        }

        .exam-card {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 2rem;
        }

        .exam-title {
            font-size: 1.8rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }

        .student-info {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        .btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            margin: 0.5rem;
        }

        .btn:hover {
            background-color: #0096c7;
            transform: translateY(-2px);
        }

        .btn-disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .btn-disabled:hover {
            transform: none;
            background-color: #555;
        }

        .already-taken {
            color: var(--danger-color);
            font-size: 1.2rem;
            margin-top: 1rem;
        }

        .result-info {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: rgba(76, 201, 240, 0.2);
            border-radius: var(--border-radius);
        }

        .result-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--success-color);
        }

                @media (max-width: 600px) {
            .container {
                padding: 5PX;
            }
            .exam-card {
                padding: 1.5rem;
            }
            .exam-title {
                font-size: 1.5rem;
            }
            .btn {
                width: 100%;
                margin: 0.5rem 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="exam-card">
            <h1 class="exam-title" id="examTitle">امتحان الرياضيات - الفصل الأول</h1>
            
            <div class="student-info" id="studentInfo">
                <!-- سيتم ملؤها بالبيانات -->
            </div>

            <div id="examContent">
                <!-- سيتم عرض محتوى الامتحان هنا -->
            </div>

            <div id="alreadyTakenMessage" class="already-taken" style="display: none;">
                <i class="fas fa-exclamation-circle"></i> لقد قمت بأداء هذا الامتحان من قبل ولا يمكنك إعادة المحاولة
            </div>

            <div id="previousResult" class="result-info" style="display: none;">
                <!-- سيتم عرض النتيجة السابقة هنا -->
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
    // ===== تهيئة Firebase =====
        const firebaseConfig = {
            apiKey: "AIzaSyCzXwAFNTz9fJvoP4MkHcHlBH5P99Xthg4",
            authDomain: "exames-d03ee.firebaseapp.com",
            projectId: "exames-d03ee",
            storageBucket: "exames-d03ee.appspot.com",
            messagingSenderId: "77352142587",
            appId: "1:77352142587:web:3ac7dfedb16e08c3a9d25e",
            measurementId: "G-GEMPVP46QJ"
        };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== بيانات الطالب من localStorage =====
    const studentData = JSON.parse(localStorage.getItem("studentData"));
    
    // إذا لم تكن البيانات موجودة، نستخدم بيانات افتراضية (لأغراض التطوير فقط)
    if (!studentData) {
        console.warn("لا توجد بيانات طالب في localStorage، يتم استخدام بيانات افتراضية للتطوير");
        studentData = {
            name: "0",
            id: "2315",
            grade: "تلتا ثانوي",
            governorate: "gharbia",
            parentPhone: "01124569879",
            school: "الققلبيل",
            studentPhone: "01255555555"
        };
    }

    // ===== بيانات الامتحان =====
    const examInfo = {
        id: "math-exam-1",
        title: "امتحان الرياضيات - الفصل الأول",
        duration: 10, // دقائق
        questions: [
            {
                id: 1,
                question: "ما هي نتيجة عملية 5 × (3 + 2) ÷ 5؟",
                options: ["5", "10", "15", "20"],
                correctAnswer: 0
            },
            {
                id: 2,
                question: "ما هو العدد الأولي من بين الأعداد التالية؟",
                options: ["15", "17", "21", "25"],
                correctAnswer: 1
            },
            {
                id: 3,
                question: "ما هو محيط دائرة نصف قطرها 7 سم؟ (π ≈ 3.14)",
                options: ["14 سم", "21.98 سم", "43.96 سم", "153.86 سم"],
                correctAnswer: 2
            }
        ]
    };

    // ===== عناصر DOM =====
    const examTitleElement = document.getElementById('examTitle');
    const studentInfoElement = document.getElementById('studentInfo');
    const examContentElement = document.getElementById('examContent');
    const alreadyTakenMessage = document.getElementById('alreadyTakenMessage');
    const previousResultElement = document.getElementById('previousResult');

    // ===== تهيئة الصفحة =====
    function initializePage() {
        // تعيين عنوان الامتحان
        examTitleElement.textContent = examInfo.title;
        
        // تعيين بيانات الطالب من localStorage
        studentInfoElement.innerHTML = `
            <p><strong>الاسم:</strong> ${studentData.name}</p>
            <p><strong>رقم الجلوس:</strong> ${studentData.studentId}</p>
            <p><strong>الصف:</strong> ${studentData.grade}</p>

        `;
        
        // التحقق مما إذا كان الطالب قد أدى الامتحان من قبل
        checkExamStatus();
    }

    // ===== التحقق من حالة الامتحان =====
    function checkExamStatus() {
        db.collection("examResults")
            .where("studentInfo.studentId", "==", studentData.studentId)
            .where("examInfo.id", "==", examInfo.id)
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    // الطالب لم يؤد الامتحان من قبل
                    displayExam();
                } else {
                    // الطالب أدى الامتحان من قبل
                    displayAlreadyTaken(snapshot.docs[0].data());
                }
            })
            .catch(error => {
                console.error("Error checking exam status: ", error);
                alert("حدث خطأ أثناء التحقق من حالة الامتحان");
            });
    }

    // ===== عرض الامتحان =====
    function displayExam() {
        examContentElement.innerHTML = `
            <div id="timer" style="font-size: 1.2rem; margin: 1rem 0;">
                <i class="fas fa-clock"></i> الوقت المتبقي: <span id="timeDisplay">${examInfo.duration}:00</span>
            </div>
            
            <div id="questionsContainer"></div>
            
            <button id="submitBtn" class="btn">
                <i class="fas fa-paper-plane"></i> تسليم الامتحان
            </button>
        `;
        
        // عرض الأسئلة
        displayQuestions();
        
        // بدء المؤقت
        startTimer();
        
        // إعداد حدث التسليم
        document.getElementById('submitBtn').addEventListener('click', submitExam);
    }

    // ===== عرض الأسئلة =====
    function displayQuestions() {
        const questionsContainer = document.getElementById('questionsContainer');
        
        examInfo.questions.forEach((question, index) => {
            const questionElement = document.createElement('div');
            questionElement.style.marginBottom = '1.5rem';
            questionElement.style.textAlign = 'right';
            questionElement.innerHTML = `
                <div style="font-weight: 500; margin-bottom: 0.5rem;">
                    ${index + 1}. ${question.question}
                </div>
                <div id="options-${index}" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${question.options.map((option, i) => `
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="question-${index}" value="${i}" style="cursor: pointer;">
                            ${option}
                        </label>
                    `).join('')}
                </div>
            `;
            
            questionsContainer.appendChild(questionElement);
        });
    }

    // ===== المؤقت =====
    function startTimer() {
        let timeLeft = examInfo.duration * 60;
        const timeDisplay = document.getElementById('timeDisplay');
        
        const timerInterval = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            
            timeDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitExam();
            } else {
                timeLeft--;
            }
        }, 1000);
    }

    // ===== عرض رسالة "تم أداء الامتحان" =====
    function displayAlreadyTaken(previousResult) {
        alreadyTakenMessage.style.display = 'block';
        
        previousResultElement.style.display = 'block';
        previousResultElement.innerHTML = `
            <div class="result-score">
                نتيجتك السابقة: ${previousResult.result.correctAnswers}/${previousResult.examInfo.questions.length}
            </div>
            <div style="margin-top: 0.5rem;">
                <i class="fas fa-calendar-alt"></i> تاريخ التسليم: 
                ${new Date(previousResult.submittedAt?.toDate()).toLocaleString()}
            </div>
        `;
        
        examContentElement.innerHTML = `

            
                        <button class="btn" onclick="window.location.href='pro/ex.html'">

                <i class="fas fa-chart-bar"></i> عرض النتائج
            </button>
        `;
    }

    // ===== تسليم الامتحان =====
    function submitExam() {
        // جمع الإجابات
        const answers = [];
        let correctCount = 0;
        
        examInfo.questions.forEach((question, index) => {
            const selectedOption = document.querySelector(`input[name="question-${index}"]:checked`);
            const answerIndex = selectedOption ? parseInt(selectedOption.value) : null;
            
            const isCorrect = answerIndex === question.correctAnswer;
            if (isCorrect) correctCount++;
            
            answers.push({
                questionId: question.id,
                selectedAnswer: answerIndex,
                correctAnswer: question.correctAnswer,
                isCorrect: isCorrect
            });
        });
        
        // تحضير بيانات النتيجة
        const examResult = {
            studentInfo: {
                name: studentData.name,
                studentId: studentData.studentId,
                grade: studentData.grade,
                school: studentData.school,
                governorate: studentData.governorate,
                parentPhone: studentData.parentPhone,
                studentPhone: studentData.studentPhone
            },
            examInfo: {
                id: examInfo.id,
                title: examInfo.title,
                questions: examInfo.questions
            },
            answers: answers,
            result: {
                correctAnswers: correctCount,
                totalQuestions: examInfo.questions.length,
                percentage: Math.round((correctCount / examInfo.questions.length) * 100)
            },
            submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // حفظ النتيجة في Firebase
        db.collection("examResults").add(examResult)
            .then(() => {
                alert(`تم تسليم الامتحان بنجاح!\nدرجتك: ${correctCount}/${examInfo.questions.length}`);
                window.location.reload();
            })
            .catch(error => {
                alert("حدث خطأ أثناء حفظ النتائج: " + error.message);
            });
    }

    // ===== بدء التطبيق =====
    initializePage();
</script>
<script>
  let leaveTime = null; // الوقت اللي ساب فيه الصفحة آخر مرة

  // لما المستخدم يسيب الصفحة (يروح تبويب تاني)
  window.addEventListener("blur", () => {
    leaveTime = Date.now(); // نسجل وقت الخروج
  });

  // لما يرجع للصفحة
  window.addEventListener("focus", () => {
    if (leaveTime) {
      const now = Date.now();
      const diffMinutes = (now - leaveTime) / 60000; // الفرق بالدقايق

      // لو عدّى أكتر من 5 دقايق
      if (diffMinutes > 5) {
        location.reload(); // نعمل ريفرش
      }
    }
  });
</script>

</body>
</html> 