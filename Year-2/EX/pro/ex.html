<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†ØªØ§Ø¦Ø¬ Ø§Ù…ØªØ­Ø§Ù†Ø§ØªÙŠ</title>
  <style>
    :root{
      --bg:#0f172a;           /* slate-900 */
      --card:#0b1226;         /* deep card */
      --muted:#94a3b8;        /* slate-400 */
      --text:#e2e8f0;         /* slate-200 */
      --accent:#22c55e;       /* green-500 */
      --danger:#ef4444;       /* red-500 */
      --ring:#1e293b;         /* slate-800 */
      --border:#1f2a44;
      --chip:#111b37;
      --chip2:#0f1a32;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0a1022,#0b132a 25%,#0a1228 60%,#0a1022);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(10,16,34,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:auto;padding:16px}

    .title{display:flex;align-items:center;gap:10px;font-weight:700;font-size:22px}
    .title svg{width:24px;height:24px}

    .student-card{display:grid;grid-template-columns:1fr 1fr;gap:12px;background:var(--card);border:1px solid var(--border);padding:16px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);margin-top:14px}
    .student-card .row{display:flex;gap:8px;align-items:center;background:linear-gradient(180deg,var(--chip),var(--chip2));border:1px solid var(--ring);padding:10px;border-radius:12px}
    .label{color:var(--muted);font-size:12px}
    .val{font-weight:600}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:16px 0}
    .input, .select, .btn{appearance:none;background:var(--card);border:1px solid var(--ring);color:var(--text);padding:10px 12px;border-radius:12px}
    .btn{cursor:pointer;border-color:transparent;background:linear-gradient(90deg,#16a34a,#22c55e);color:#03110a;font-weight:700}
    .switch{display:flex;align-items:center;gap:8px}

        @media (max-width: 600px) {
      .title {
        padding: 20px;
        font-size: 25px;
      }
      .wrap {
        padding: 10px 5px 40px 5px;
        max-width: 100vw;
      }
      .student-card {
        grid-template-columns: 1fr;
        padding: 10px;
        gap: 8px;
        border-radius: 10px;
        margin-top: 8px;
      }
      .row {
        padding: 8px;
        font-size: 15px;
      }
      .toolbar {
        flex-direction: column;
        gap: 8px;
        margin: 10px 0;
      }
      .input, .select, .btn {
        padding: 8px 10px;
        font-size: 15px;
        border-radius: 10px;
      }
      .exam-card {
        border-radius: 10px;
      }
      .exam-head {
        flex-direction: column;
        gap: 8px;
        padding: 10px;
      }
      .meta {
        font-size: 11px;
        gap: 6px;
      }
      .chip {
        padding: 5px 8px;
        font-size: 11px;
      }
      .bar {
        min-width: 120px;
        height: 8px;
      }
      summary {
        padding: 0 10px 10px;
      }
      .q {
        padding: 10px 10px;
        font-size: 15px;
      }
      .badge {
        font-size: 11px;
        padding: 5px 8px;
      }
      .options {
        gap: 6px;
      }
      .opt {
        padding: 8px;
        font-size: 15px;
        border-radius: 8px;
      }
      .empty {
        padding: 16px;
        font-size: 15px;
        border-radius: 10px;
      }
    }.grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:700px){.grid{grid-template-columns:1fr 1fr}}

    .exam-card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .exam-head{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--ring)}
    .exam-title{font-weight:700}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .chip{border:1px solid var(--ring);padding:6px 10px;border-radius:999px}

    .bar{height:10px;background:#0a162e;border:1px solid var(--ring);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#16a34a,#22c55e)}

    details{transition:all .3s ease}
    summary{cursor:pointer;list-style:none;padding:0 16px 16px}
    summary::-webkit-details-marker{display:none}
    .q{border-top:1px solid var(--ring);padding:14px 16px}
    .q-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .badge{font-size:12px;border-radius:999px;padding:6px 10px;border:1px solid var(--ring)}
    .ok{background:rgba(34,197,94,.12);color:#86efac}
    .bad{background:rgba(239,68,68,.12);color:#fecaca}

    .options{display:grid;gap:8px;margin-top:10px}
    .opt{padding:10px;border-radius:10px;border:1px solid var(--ring);display:flex;justify-content:space-between;align-items:center}
    .opt.chosen{outline:2px dashed #22c55e;outline-offset:2px}
    .opt.correct{background:rgba(34,197,94,.1)}
    .opt.wrong{background:rgba(239,68,68,.08)}

    .empty{padding:24px;text-align:center;color:var(--muted);border:1px dashed var(--ring);border-radius:16px;background:rgba(2,6,23,.3)}

    .hl{color:#a5b4fc}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4h16v13a1 1 0 0 1-1.447.894L12 14l-6.553 3.894A1 1 0 0 1 4 17V4Z" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>Ù†ØªØ§Ø¦Ø¬ Ø§Ù…ØªØ­Ø§Ù†Ø§ØªÙŠ</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="student-card" id="studentCard"></section>

    <div class="toolbar">
      <input id="search" class="input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†..." />
      <label class="switch">
        <input id="onlyWrong" type="checkbox" />
        <span>Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø®Ø§Ø·Ø¦Ø© ÙÙ‚Ø·</span>
      </label>
      <button id="reload" class="btn">ØªØ­Ø¯ÙŠØ«</button>
    </div>

    <section id="examsContainer" class="grid">
      <div class="empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬Ùƒ...</div>
    </section>
  </main>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // ===== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase =====
        const firebaseConfig = {
            apiKey: "AIzaSyCzXwAFNTz9fJvoP4MkHcHlBH5P99Xthg4",
            authDomain: "exames-d03ee.firebaseapp.com",
            projectId: "exames-d03ee",
            storageBucket: "exames-d03ee.appspot.com",
            messagingSenderId: "77352142587",
            appId: "1:77352142587:web:3ac7dfedb16e08c3a9d25e",
            measurementId: "G-GEMPVP46QJ"
        };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† localStorage (Ø­Ù‚ÙŠÙ‚ÙŠØ©) =====
    const studentData = JSON.parse(localStorage.getItem('studentData'));
    if (!studentData) {
      document.getElementById('examsContainer').innerHTML = '<div class="empty">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.</div>';
      throw new Error('no studentData in localStorage');
    }

    // ===== Ø¹Ø±Ø¶ ÙƒØ§Ø±Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ =====
    const sCard = document.getElementById('studentCard');
    sCard.innerHTML = `
      <div class="row"><span class="label">Ø§Ù„Ø§Ø³Ù…</span><span class="val">${studentData.name || '-'}</span></div>
      <div class="row"><span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</span><span class="val">${studentData.studentId || '-'}</span></div>
      <div class="row"><span class="label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</span><span class="val">${studentData.governorate || '-'}</span></div>
      <div class="row"><span class="label">Ø§Ù„ØµÙ</span><span class="val">${studentData.grade || '-'}</span></div>
      <div class="row"><span class="label">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</span><span class="val">${studentData.school || '-'}</span></div>
      <div class="row"><span class="label">Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</span><span class="val">${studentData.parentPhone || '-'}</span></div>
      <div class="row"><span class="label">Ù…ÙˆØ¨Ø§ÙŠÙ„ÙŠ</span><span class="val">${studentData.studentPhone || '-'}</span></div>
    `;

    const container = document.getElementById('examsContainer');
    const onlyWrongEl = document.getElementById('onlyWrong');
    const searchEl = document.getElementById('search');

    let allResults = [];

    async function loadResults(){
      container.innerHTML = '<div class="empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬Ùƒ...</div>';
      try{
        // Ù…ÙÙŠØ´ orderBy Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† Ù†ØªØ¬Ù†Ø¨ Ø¥Ù†Ø´Ø§Ø¡ index Ù…Ø±ÙƒØ¨
        const snap = await db.collection('examResults')
          .where('studentInfo.studentId','==', studentData.studentId)
          .get();

        allResults = snap.docs.map(d=>({ id:d.id, ...d.data() }));

        // ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„ÙˆÙ‚Øª (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯) Ø¨Ø¯ÙˆÙ† Ø·Ù„Ø¨ index
        allResults.sort((a,b)=>{
          const ta = a.submittedAt?.toDate ? a.submittedAt.toDate().getTime() : 0;
          const tb = b.submittedAt?.toDate ? b.submittedAt.toDate().getTime() : 0;
          return tb - ta;
        });

        render();
      }catch(err){
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:', err);
        container.innerHTML = '<div class="empty">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>';
      }
    }

    function percent(p){
      if (typeof p === 'number') return p;
      return 0;
    }

    function render(){
      const term = (searchEl.value || '').trim();
      const data = allResults.filter(r=>{
        if(!term) return true;
        const title = r.examInfo?.title || r.examInfo?.id || '';
        return title.includes(term);
      });

      if (!data.length){
        container.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>';
        return;
      }

      container.innerHTML = '';

      data.forEach(r=>{
        const title = r.examInfo?.title || r.examInfo?.id || 'Ø§Ù…ØªØ­Ø§Ù†';
        const total = r.result?.totalQuestions ?? (r.examInfo?.questions?.length || 0);
        const correct = r.result?.correctAnswers ?? 0;
        const pct = r.result?.percentage ?? Math.round(total? (correct/total)*100 : 0);
        const dateStr = r.submittedAt?.toDate ? new Date(r.submittedAt.toDate()).toLocaleString() : '-';

        // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
        const card = document.createElement('div');
        card.className = 'exam-card';
        card.innerHTML = `
          <div class="exam-head">
            <div>
              <div class="exam-title">${title}</div>
              <div class="meta">
                <span class="chip">Ø§Ù„Ø¯Ø±Ø¬Ø©: <span class="hl">${correct}</span> / ${total}</span>
                <span class="chip">Ø§Ù„Ù†Ø³Ø¨Ø©: <span class="hl">${pct}%</span></span>
                <span class="chip">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}</span>
              </div>
            </div>
            <div style="min-width:180px">
              <div class="bar" title="${pct}%">
                <span style="width:${pct}%"></span>
              </div>
            </div>
          </div>

          <details>
            <summary>Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</summary>
            <div class="qs"></div>
          </details>
        `;

        const qsWrap = card.querySelector('.qs');
        const qs = Array.isArray(r.examInfo?.questions) ? r.examInfo.questions : [];
        const answersArr = Array.isArray(r.answers) ? r.answers : [];
        const ansById = Object.create(null);
        answersArr.forEach(a=>{ ansById[a.questionId] = a; });

        qs.forEach((q, idx)=>{
          const ans = ansById[q.id] || {};
          const chosen = (typeof ans.selectedAnswer === 'number') ? ans.selectedAnswer : null;
          const isOk = !!ans.isCorrect;
          const correctIndex = q.correctAnswer;

          // ÙÙ„ØªØ± "Ø£Ø®Ø·Ø§Ø¡ ÙÙ‚Ø·" ÙŠØ·Ø¨Ù‚ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
          if (onlyWrongEl.checked && isOk) return;

          const div = document.createElement('div');
          div.className = 'q';
          div.innerHTML = `
            <div class="q-head">
              <div><strong>Ø³${idx+1}:</strong> ${q.question || ''}</div>
              <span class="badge ${isOk ? 'ok' : 'bad'}">${isOk ? 'âœ”ï¸ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©' : 'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©'}</span>
            </div>
            <div class="options"></div>
          `;
          const opts = div.querySelector('.options');

          (q.options || []).forEach((txt, i)=>{
            const item = document.createElement('div');
            const classes = ['opt'];
            if (i === chosen) classes.push('chosen');
            if (i === correctIndex) classes.push('correct');
            if (i === chosen && i !== correctIndex) classes.push('wrong');
            item.className = classes.join(' ');
            item.innerHTML = `<span>${txt}</span>${i===correctIndex ? '<span>âœ…</span>' : (i===chosen ? '<span>ğŸŸ¡</span>' : '<span></span>')}`;
            opts.appendChild(item);
          });

          qsWrap.appendChild(div);
        });

        container.appendChild(card);
      });
    }

    // ØªÙØ§Ø¹Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById('reload').addEventListener('click', loadResults);
    onlyWrongEl.addEventListener('change', render);
    searchEl.addEventListener('input', render);

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    loadResults();
  </script>
</body>
</html>