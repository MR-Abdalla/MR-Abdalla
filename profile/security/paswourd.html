<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¹Ø¨Ø± SMS</title>
  <style>
    body { font-family: Arial, "Tajawal", sans-serif; background:#f3f6fb; display:flex; align-items:center; justify-content:center; min-height:100vh; }
    .card { background:#fff; padding:22px; border-radius:12px; box-shadow:0 6px 18px rgba(20,40,80,0.08); width:360px; }
    h2 { margin:0 0 14px 0; text-align:center; }
    input { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ddd; box-sizing:border-box; text-align:center; }
    button { width:100%; padding:10px; margin-top:10px; border-radius:8px; border:none; background:#0b79ff; color:#fff; cursor:pointer; }
    button:disabled { background:#9ec7ff; cursor:not-allowed; }
    .small { font-size:13px; color:#666; text-align:center; margin-top:8px; }
    #recaptcha-container { margin-top:10px; display:flex; justify-content:center; }
  </style>
</head>
<body>
  <div class="card">
    <h2>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¹Ø¨Ø± SMS</h2>

    <!-- STEP 1: phone input -->
    <div id="step-phone">
      <input id="phone" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¨ØµÙŠØºØ© +20XXXXXXXXXX (Ù…Ø«Ø§Ù„: +201234567890)" />
      <div id="recaptcha-container"></div>
      <button id="sendCodeBtn">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</button>
      <div class="small">ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Phone sign-in ÙÙŠ Firebase Console Ùˆ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† 127.0.0.1</div>
    </div>

    <!-- STEP 2: code verification -->
    <div id="step-code" style="display:none;">
      <input id="code" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (OTP)" />
      <button id="verifyCodeBtn">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯</button>
    </div>

    <!-- STEP 3: new password -->
    <div id="step-newpass" style="display:none;">
      <input id="newPass" type="password" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" />
      <button id="changePassBtn">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¢Ù†</button>
      <div class="small" id="status"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth,
      RecaptchaVerifier,
      signInWithPhoneNumber,
      updatePassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCPrQEr2OXfcjPyCRb5uT9KQKZjf5aBDg8",
      authDomain: "studint-code.firebaseapp.com",
      projectId: "studint-code",
      storageBucket: "studint-code.firebasestorage.app",
      messagingSenderId: "736980801683",
      appId: "1:736980801683:web:9e7b1f7caf90b39ded5566",
      measurementId: "G-JV9BQ5KTS9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ğŸ”§ Ù„ØªØ¬Ø§Ø±Ø¨ Ù…Ø­Ù„ÙŠØ© Ø¨Ø¯ÙˆÙ† SMS Ø­Ù‚ÙŠÙ‚ÙŠ
    auth.settings.appVerificationDisabledForTesting = true; // âš ï¸ Ù„Ø§ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ

    let recaptchaVerifier;
    function setupRecaptcha() {
      if (recaptchaVerifier) return recaptchaVerifier;
      recaptchaVerifier = new RecaptchaVerifier(auth, "recaptcha-container", {
        size: "normal",
        callback: () => console.log("reCAPTCHA success"),
        "expired-callback": () => console.log("reCAPTCHA expired")
      });
      recaptchaVerifier.render();
      return recaptchaVerifier;
    }

    // Ø¹Ù†Ø§ØµØ± HTML
    const phoneInput = document.getElementById("phone");
    const sendCodeBtn = document.getElementById("sendCodeBtn");
    const codeInput = document.getElementById("code");
    const verifyCodeBtn = document.getElementById("verifyCodeBtn");
    const newPassInput = document.getElementById("newPass");
    const changePassBtn = document.getElementById("changePassBtn");
    const statusEl = document.getElementById("status");

    const stepPhone = document.getElementById("step-phone");
    const stepCode = document.getElementById("step-code");
    const stepNewPass = document.getElementById("step-newpass");

    let confirmationResult;

    sendCodeBtn.onclick = async () => {
      const phone = phoneInput.value.trim();
      if (!phone) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨ØµÙŠØºØ© +20...");
      sendCodeBtn.disabled = true;
      try {
        setupRecaptcha();
        confirmationResult = await signInWithPhoneNumber(auth, phone, recaptchaVerifier);
        stepPhone.style.display = "none";
        stepCode.style.display = "block";
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ùˆ Ù…Ø­Ø¯Ø¯)");
      } catch (err) {
        console.error(err);
        alert("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯: " + err.message);
      } finally {
        sendCodeBtn.disabled = false;
      }
    };

    verifyCodeBtn.onclick = async () => {
      const code = codeInput.value.trim();
      if (!code) return alert("Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚");
      verifyCodeBtn.disabled = true;
      try {
        await confirmationResult.confirm(code);
        stepCode.style.display = "none";
        stepNewPass.style.display = "block";
        statusEl.textContent = "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.";
      } catch (err) {
        console.error(err);
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯: " + err.message);
      } finally {
        verifyCodeBtn.disabled = false;
      }
    };

    changePassBtn.onclick = async () => {
      const newPass = newPassInput.value.trim();
      if (!newPass) return alert("Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©");
      changePassBtn.disabled = true;
      try {
        const user = auth.currentUser;
        if (!user) throw new Error("Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚");
        await updatePassword(user, newPass);
        statusEl.textContent = "âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¨Ù†Ø¬Ø§Ø­.";
        await signOut(auth);
        alert("ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±. Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø¬Ø¯ÙŠØ¯.");
        location.reload();
      } catch (err) {
        console.error(err);
        alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±: " + err.message);
      } finally {
        changePassBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
