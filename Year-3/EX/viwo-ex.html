<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø­Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #ff7b25; /* ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
      --primary-dark: #e56a1a;
      --primary-light: #ff9d54;
      --secondary: #ff8800;
      --accent: #f76c28;
      --success: #4cc9f0;
      --warning: #ff9500;
      --danger: #e63946;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 16px;
      --border-radius-sm: 10px;
      --box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      --box-shadow-lg: 0 15px 40px rgba(0,0,0,0.12);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #fff9f5 0%, #ffefe6 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    
    .card {
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      margin-bottom: 25px;
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: var(--box-shadow-lg);
    }
    
    .card-header {
      padding: 25px 30px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }
    
    .card-body {
      padding: 30px;
    }
    
    .exam-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .exam-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .exam-meta {
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .exam-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .timer {
      font-weight: 700;
      background: rgba(255, 255, 255, 0.2);
      padding: 12px 20px;
      border-radius: var(--border-radius-sm);
      font-size: 1.3rem;
      margin-bottom: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .student-info {
      font-weight: 500;
      background: rgba(255, 255, 255, 0.15);
      padding: 8px 15px;
      border-radius: var(--border-radius-sm);
    }
    
    .question-area {
      margin: 25px 0;
    }
    
    .question-card {
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      background: #fffaf7;
      box-shadow: 0 5px 15px rgba(0,0,0,0.03);
      transition: var(--transition);
    }
    
    .question-card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.06);
    }
    
    .question-image {
      width: 70%;
      height: auto;
      border-radius: var(--border-radius-sm);
      display: block;
      margin: 20px auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border: 1px solid var(--gray-light);
    }
    
    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 25px;
    }
    
    .option-btn {
      padding: 18px;
      border-radius: var(--border-radius-sm);
      border: 2px solid var(--gray-light);
      background: #fff;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
      transition: var(--transition);
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 70px;
    }
    
    .option-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border-color: var(--primary-light);
    }
    
    .option-btn.selected {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      box-shadow: 0 8px 20px rgba(255, 123, 37, 0.3);
      transform: translateY(-2px);
    }
    
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 35px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .nav-buttons {
      display: flex;
      gap: 15px;
    }
    
    .btn {
      padding: 14px 28px;
      border-radius: var(--border-radius-sm);
      border: none;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      font-family: 'Cairo', sans-serif;
      font-size: 1rem;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: var(--primary);
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--secondary);
    }
    
    .btn-secondary:hover {
      background: #e67a00;
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-danger:hover {
      background: #c1121f;
    }
    
    .progress-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      max-width: 300px;
    }
    
    .progress-label {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    
    .progress-container {
      width: 100%;
      height: 12px;
      background: var(--gray-light);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 6px;
      transition: width 0.5s ease;
    }
    
    .progress-text {
      font-size: 0.9rem;
      color: var(--gray);
    }
    
    .warning-box {
      margin-top: 25px;
      padding: 20px;
      background: #fff9e6;
      border-radius: var(--border-radius-sm);
      border-right: 5px solid var(--warning);
      display: flex;
      align-items: flex-start;
      gap: 15px;
    }
    
    .warning-icon {
      color: var(--warning);
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    
    .warning-text {
      color: #856404;
    }
    
    .warn {
      color: var(--danger);
      font-weight: 700;
    }
    
    textarea {
      width: 100%;
      min-height: 180px;
      padding: 18px;
      border-radius: var(--border-radius-sm);
      border: 2px solid var(--gray-light);
      margin-top: 20px;
      font-family: 'Cairo', sans-serif;
      font-size: 1rem;
      resize: vertical;
      transition: var(--transition);
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 123, 37, 0.1);
    }
    
    .hidden {
      display: none;
    }
    
    .center {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
    }
    
    /* Ù†Ù…ÙˆØ°Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ */
    .form-container {
      max-width: 600px;
      margin: 50px auto;
    }
    
    .form-title {
      text-align: center;
      margin-bottom: 30px;
      color: var(--primary);
      font-size: 1.8rem;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--dark);
      font-size: 1.1rem;
    }
    
    .form-input {
      width: 100%;
      padding: 16px 20px;
      border-radius: var(--border-radius-sm);
      border: 2px solid var(--gray-light);
      font-family: 'Cairo', sans-serif;
      font-size: 1rem;
      transition: var(--transition);
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 123, 37, 0.1);
    }
    
    .btn-submit {
      width: 100%;
      padding: 18px;
      font-size: 1.1rem;
      background: var(--primary);
      margin-top: 10px;
    }
    
    .btn-submit:hover {
      background: var(--primary-dark);
    }
    
    /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© */
    .result-card {
      text-align: center;
      padding: 40px;
    }
    
    .result-icon {
      font-size: 5rem;
      margin-bottom: 20px;
    }
    
    .result-title {
      font-size: 2.2rem;
      margin-bottom: 15px;
      color: var(--primary);
    }
    
    .result-score {
      font-size: 3.5rem;
      font-weight: 700;
      margin: 20px 0;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .result-details {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 25px 0;
      flex-wrap: wrap;
    }
    
    .result-detail {
      background: var(--light);
      padding: 15px 25px;
      border-radius: var(--border-radius-sm);
      min-width: 150px;
    }
    
    .result-detail-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .result-detail-label {
      font-size: 0.9rem;
      color: var(--gray);
      margin-top: 5px;
    }
    
    .result-message {
      font-size: 1.2rem;
      margin: 25px 0;
      color: var(--dark);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 768px) {
      .card-body {
        padding: 10px;
      }
      
      .exam-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .exam-info {
        align-items: flex-start;
        width: 100%;
      }
      
      .navigation {
        flex-direction: column;
      }
      
      .nav-buttons {
        width: 100%;
        justify-content: space-between;
      }
      
      .progress-section {
        width: 100%;
        max-width: 100%;
        margin: 15px 0;
      }
      
      .options-grid {
        grid-template-columns: 1fr;
      }
      
      .btn {
        padding: 12px 20px;
      }
      
      .result-details {
        flex-direction: column;
        gap: 15px;
      }
      
      .result-detail {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .card-header {
        padding: 20px;
      }
      
      .exam-title {
        font-size: 1.5rem;
      }
      
      .timer {
        font-size: 1.1rem;
        padding: 10px 15px;
      }
      
      .question-card {
        padding: 0px ;
      }
      
      .option-btn {
        padding: 15px;
        min-height: 60px;
      }
      
      .result-card {
        padding: 25px 15px;
      }
      
      .result-title {
        font-size: 1.8rem;
      }
      
      .result-score {
        font-size: 2.8rem;
      }

       .question-image {
      width: 100%;
    }
    }
    
    /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 123, 37, 0.4);
      }
      70% {
        box-shadow: 0 0 0 12px rgba(255, 123, 37, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(255, 123, 37, 0);
      }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .shake {
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
    @media (min-width: 1200px) {
      .container {
        max-width: 1200px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù† -->
    <div id="examWrap" class="card fade-in">
      <div class="card-header">
        <div class="exam-header">
          <div>
            <h1 class="exam-title" id="examTitle">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†...</h1>
            <div class="exam-meta" id="qCount">--</div>
          </div>
          <div class="exam-info">
            <div class="timer" id="timer">--:--:--</div>
            <div class="student-info" id="studentName"></div>
          </div>
        </div>
      </div>
      
      <div class="card-body">
        <div class="question-area" id="questionArea">
          <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
        </div>
        
        <div class="navigation">
          <div class="nav-buttons">
            <button id="prevBtn" class="btn btn-secondary">
              <span>â†</span> Ø§Ù„Ø³Ø§Ø¨Ù‚
            </button>
            <button id="nextBtn" class="btn btn-primary">
              Ø§Ù„ØªØ§Ù„ÙŠ <span>â†’</span>
            </button>
          </div>
          
          <div class="progress-section">
            <div class="progress-label" id="posLabel">Ø³Ø¤Ø§Ù„ 0 Ù…Ù† 0</div>
            <div class="progress-container">
              <div class="progress-bar" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progressText">0% Ù…ÙƒØªÙ…Ù„</div>
          </div>
          
          <button id="endBtn" class="btn btn-danger">
            <span>â¹</span> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
          </button>
        </div>
        
        <div class="warning-box">
          <div class="warning-icon">âš </div>
          <div class="warning-text">
            <span class="warn">Ù…Ù„Ø§Ø­Ø¸Ø©:</span> Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ùˆ ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø± â€” Ø³ÙŠØ¸Ù‡Ø± ØªØ­Ø°ÙŠØ± Ø£ÙˆÙ„ Ù…Ø±Ø© ÙˆØ¥Ø°Ø§ ÙƒØ±Ø±Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
          </div>
        </div>
      </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ -->
    <div id="studentFormWrap" class="card form-container hidden">
      <div class="card-header">
        <h2 class="form-title">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h2>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="sf_name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input type="text" id="sf_name" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
        </div>
        
        <div class="form-group">
          <label for="sf_id">Ø§Ù„ÙƒÙˆØ¯ (studentId)</label>
          <input type="text" id="sf_id" class="form-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: 9763">
        </div>
        
        <div class="form-group">
          <label for="sf_grade">Ø§Ù„ØµÙ</label>
          <input type="text" id="sf_grade" class="form-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªØ§Ù„ØªØ© Ø«Ø§Ù†ÙˆÙŠ">
        </div>
        
        <div class="form-group">
          <label for="sf_governorate">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
          <input type="text" id="sf_governorate" class="form-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø¨Ø­ÙŠØ±Ø©">
        </div>
        
        <button id="sf_save" class="btn btn-submit pulse">Ø­ÙØ¸ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
    <div id="resultWrap" class="card hidden">
      <div class="card-body result-card">
        <div class="result-icon">ğŸ“</div>
        <h2 class="result-title">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h2>
        <div class="result-score" id="resultScore">0/0</div>
        
        <div class="result-details">
          <div class="result-detail">
            <div class="result-detail-value" id="correctAnswers">0</div>
            <div class="result-detail-label">Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>
          </div>
          <div class="result-detail">
            <div class="result-detail-value" id="totalQuestions">0</div>
            <div class="result-detail-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
          </div>
          <div class="result-detail">
            <div class="result-detail-value" id="percentage">0%</div>
            <div class="result-detail-label">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</div>
          </div>
        </div>
        
        <div class="result-message" id="resultMessage">
          Ù„Ù‚Ø¯ Ø£Ù†Ù‡ÙŠØª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£Ø¹Ù„Ø§Ù‡.
        </div>
        
       
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, serverTimestamp, addDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ========  Ø¹Ø¯Ù‘Ù„ Ù‡Ù†Ø§ Ø¨Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ²Ù‡ ========
    const EXAM_NAME = "Ø§Ù…ØªØ­Ø§Ù† Ø´Ø§Ù…Ù„ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø§ÙˆÙ„"; // <-- Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙƒÙ…Ø§ ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù€ exams
    // ====================================================

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCdBkYrgoSfPb5bQ2PwJ36BPETLbDVdx_4",
      authDomain: "exam-a281f.firebaseapp.com",
      projectId: "exam-a281f",
      storageBucket: "exam-a281f.firebasestorage.app",
      messagingSenderId: "658674221293",
      appId: "1:658674221293:web:7f28c753dd677b60930ce4",
      measurementId: "G-084CGTYJX1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ø¹Ù†Ø§ØµØ± DOM
    const examWrap = document.getElementById("examWrap");
    const examTitle = document.getElementById("examTitle");
    const qCountEl = document.getElementById("qCount");
    const questionArea = document.getElementById("questionArea");
    const posLabel = document.getElementById("posLabel");
    const progressFill = document.getElementById("progressFill");
    const progressText = document.getElementById("progressText");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const endBtn = document.getElementById("endBtn");
    const timerEl = document.getElementById("timer");
    const studentNameEl = document.getElementById("studentName");

    const studentFormWrap = document.getElementById("studentFormWrap");
    const sf_name = document.getElementById("sf_name");
    const sf_id = document.getElementById("sf_id");
    const sf_grade = document.getElementById("sf_grade");
    const sf_governorate = document.getElementById("sf_governorate");
    const sf_save = document.getElementById("sf_save");

    const resultWrap = document.getElementById("resultWrap");
    const resultScore = document.getElementById("resultScore");
    const correctAnswers = document.getElementById("correctAnswers");
    const totalQuestions = document.getElementById("totalQuestions");
    const percentage = document.getElementById("percentage");
    const resultMessage = document.getElementById("resultMessage");

    let examDoc = null;
    let questions = [];
    let idx = 0;
    let answers = [];
    let remainingSeconds = 0;
    let timerInterval = null;
    let warningsCount = 0;
    let autoSubmitted = false;
    let studentObj = null;
    let isSubmitting = false; // Ù…ØªØºÙŠØ± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬

    // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ù‚Ø¯ Ø£Ø¯Ù‰ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ù† Ù‚Ø¨Ù„
    async function checkIfExamTaken(studentId, examName) {
      try {
        const q = query(
          collection(db, "studentExam"), 
          where("studentId", "==", studentId),
          where("examName", "==", examName)
        );
        const snap = await getDocs(q);
        return !snap.empty;
      } catch(err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:", err);
        return false;
      }
    }

    // Ø¬Ù„Ø¨ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    async function getPreviousResult(studentId, examName) {
      try {
        const q = query(
          collection(db, "studentExam"), 
          where("studentId", "==", studentId),
          where("examName", "==", examName)
        );
        const snap = await getDocs(q);
        if (snap.empty) return null;
        
        const doc = snap.docs[0];
        return {
          score: doc.data().score,
          totalScore: doc.data().totalScore,
          createdAt: doc.data().createdAt
        };
      } catch(err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©:", err);
        return null;
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    function showPreviousResult(score, totalScore) {
      examWrap.classList.add("hidden");
      studentFormWrap.classList.add("hidden");
      resultWrap.classList.remove("hidden");
      
      const percent = Math.round((score / totalScore) * 100);
      
      resultScore.textContent = `${score}/${totalScore}`;
      correctAnswers.textContent = score;
      totalQuestions.textContent = totalScore;
      percentage.textContent = `${percent}%`;
      
      let message = "Ù„Ù‚Ø¯ Ø£Ø¯ÙŠØª Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ù† Ù‚Ø¨Ù„. Ù‡Ø°Ù‡ Ù‡ÙŠ Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.";
      if (percent >= 90) {
        message = "Ù…Ù…ØªØ§Ø²! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ø±Ø§Ø¦Ø¹Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ù† Ù‚Ø¨Ù„.";
      } else if (percent >= 70) {
        message = "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! Ù‡Ø°Ù‡ Ù‡ÙŠ Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.";
      } else if (percent >= 50) {
        message = "Ù…Ù‚Ø¨ÙˆÙ„. Ù‡Ø°Ù‡ Ù‡ÙŠ Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.";
      } else {
        message = "Ù„Ù„Ø£Ø³ÙØŒ Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù„Ù… ØªÙƒÙ† Ø¬ÙŠØ¯Ø©.";
      }
      
      resultMessage.textContent = message;
    }

    // Ø­Ø§ÙˆÙ„ Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† localStorage
    function loadStudentFromStorage() {
      const keys = ["studentData","StudentData","student","studentInfo","StudentInfo"];
      for (const k of keys) {
        try {
          const val = localStorage.getItem(k);
          if (!val) continue;
          const obj = JSON.parse(val);
          if (obj.name && obj.studentId) return obj;
        } catch(e){ continue; }
      }
      return null;
    }

    function saveStudentToStorage(obj){
      localStorage.setItem("studentData", JSON.stringify(obj));
    }

    function showStudentForm(){
      examWrap.classList.add("hidden");
      resultWrap.classList.add("hidden");
      studentFormWrap.classList.remove("hidden");
    }

    sf_save.addEventListener("click", async () => {
      const name = sf_name.value.trim();
      const studentId = sf_id.value.trim();
      const grade = sf_grade.value.trim();
      const governorate = sf_governorate.value.trim();
      
      if(!name || !studentId){ 
        alert("Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙˆØ¯ Ø¹Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†Ø¨Ø¹Øª Ø§Ù„Ù†ØªÙŠØ¬Ø©"); 
        return; 
      }
      
      // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ù‚Ø¯ Ø£Ø¯Ù‰ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ù† Ù‚Ø¨Ù„
      const examTaken = await checkIfExamTaken(studentId, EXAM_NAME);
      if (examTaken) {
        const previousResult = await getPreviousResult(studentId, EXAM_NAME);
        if (previousResult) {
          showPreviousResult(previousResult.score, previousResult.totalScore);
          return;
        }
      }
      
      const obj = { name, studentId, grade, governorate };
      saveStudentToStorage(obj);
      studentFormWrap.classList.add("hidden");
      examWrap.classList.remove("hidden");
      initAfterStudent();
    });

    studentObj = loadStudentFromStorage();
    if(!studentObj){
      showStudentForm();
    } else {
      initAfterStudent();
    }

    async function initAfterStudent(){
      studentObj = loadStudentFromStorage();
      studentNameEl.textContent = studentObj ? `${studentObj.name} â€” ${studentObj.studentId}` : "";
      
      // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ù‚Ø¯ Ø£Ø¯Ù‰ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ù† Ù‚Ø¨Ù„
      const examTaken = await checkIfExamTaken(studentObj.studentId, EXAM_NAME);
      if (examTaken) {
        const previousResult = await getPreviousResult(studentObj.studentId, EXAM_NAME);
        if (previousResult) {
          showPreviousResult(previousResult.score, previousResult.totalScore);
          return;
        }
      }
      
      loadExamByName(EXAM_NAME);
      setupAntiCheat();
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ù† collection exams Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
    async function loadExamByName(name){
      examTitle.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†...";
      try {
        const q = query(collection(db, "exams"), where("name", "==", name));
        const snap = await getDocs(q);
        if(snap.empty){ 
          examTitle.textContent = "Ù…Ø§ ØªÙ…Ø´ Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù„ÙŠ ÙƒØªØ¨ØªÙ‡"; 
          return; 
        }
        
        const docSnap = snap.docs[0];
        examDoc = { id: docSnap.id, ...docSnap.data() };
        questions = Array.isArray(examDoc.questions) ? examDoc.questions : [];
        
        examTitle.textContent = examDoc.name || name;
        qCountEl.textContent = `Ø§Ù„ØµÙ: ${examDoc.grade || "-"} â€” Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${questions.length}`;
        
        if (typeof examDoc.time === "number") {
          remainingSeconds = examDoc.time;
        } else {
          remainingSeconds = 0;
        }
        
        if (remainingSeconds <= 0) remainingSeconds = (questions.length * 60);
        
        answers = questions.map(q=> ({ chosen: null, text: "" }) );
        renderQuestion(0);
        startTimer();
      } catch(err){
        console.error(err);
        examTitle.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†";
      }
    }

    // ØµÙŠØºØ© Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª hh:mm:ss
    function formatTime(s){
      const h = Math.floor(s/3600); 
      const m = Math.floor((s%3600)/60); 
      const sec = s%60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    function startTimer(){
      timerEl.textContent = formatTime(remainingSeconds);
      timerInterval = setInterval(()=>{
        remainingSeconds--;
        if(remainingSeconds < 0){
          clearInterval(timerInterval);
          if(!autoSubmitted) {
            autoSubmitted = true;
            alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª. Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¢Ù†.");
            submitExam();
          }
          return;
        }
        timerEl.textContent = formatTime(remainingSeconds);
      }, 1000);
    }

    function renderQuestion(i){
      idx = i;
      const q = questions[i];
      posLabel.textContent = `Ø³Ø¤Ø§Ù„ ${i+1} Ù…Ù† ${questions.length}`;
      const progress = ((i+1) / questions.length) * 100;
      progressFill.style.width = `${progress}%`;
      progressText.textContent = `${Math.round(progress)}% Ù…ÙƒØªÙ…Ù„`;
      
      questionArea.innerHTML = "";
      const card = document.createElement("div");
      card.className = "question-card fade-in";

      if (q.questionImage) {
        const img = document.createElement("img");
        img.src = q.questionImage;
        img.alt = `Ø³Ø¤Ø§Ù„ ${i+1}`;
        img.className = "question-image";
        card.appendChild(img);
      }

      if(q.type === "Ø§Ø®ØªÙŠØ§Ø±ÙŠ"){
        const opts = document.createElement("div");
        opts.className = "options-grid";
        ["Ø£","Ø¨","Ø¬","Ø¯"].forEach(letter=>{
          const btn = document.createElement("div");
          btn.className = "option-btn";
          btn.textContent = letter;
          if(answers[i].chosen === letter) btn.classList.add("selected");
          btn.addEventListener("click", ()=>{
            answers[i].chosen = letter;
            card.querySelectorAll(".option-btn").forEach(el=>el.classList.remove("selected"));
            btn.classList.add("selected");
          });
          opts.appendChild(btn);
        });
        card.appendChild(opts);
      } else {
        const ta = document.createElement("textarea");
        ta.placeholder = "Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§...";
        ta.value = answers[i].text || "";
        ta.addEventListener("input", ()=> answers[i].text = ta.value);
        card.appendChild(ta);
      }

      questionArea.appendChild(card);

      prevBtn.disabled = (i === 0);
      nextBtn.disabled = (i === questions.length - 1);
    }

    prevBtn.addEventListener("click", ()=> {
      if(idx > 0) renderQuestion(idx-1);
    });
    
    nextBtn.addEventListener("click", ()=> {
      if(idx < questions.length-1) renderQuestion(idx+1);
    });

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    function showResult(score, totalScore) {
      examWrap.classList.add("hidden");
      resultWrap.classList.remove("hidden");
      
      const percent = Math.round((score / totalScore) * 100);
      
      resultScore.textContent = `${score}/${totalScore}`;
      correctAnswers.textContent = score;
      totalQuestions.textContent = totalScore;
      percentage.textContent = `${percent}%`;
      
      let message = "Ù„Ù‚Ø¯ Ø£Ù†Ù‡ÙŠØª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­! Ù‡Ø°Ù‡ Ù‡ÙŠ Ù†ØªÙŠØ¬ØªÙƒ.";
      if (percent >= 90) {
        message = "Ù…Ù…ØªØ§Ø²! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ø±Ø§Ø¦Ø¹Ø©. Ø£Ø­Ø³Ù†Øª Ø¹Ù…Ù„Ù‹Ø§!";
      } else if (percent >= 70) {
        message = "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! Ù„Ù‚Ø¯ Ø£Ø¯ÙŠØª Ø¨Ø´ÙƒÙ„ Ù…Ù…ØªØ§Ø² ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.";
      } else if (percent >= 50) {
        message = "Ù…Ù‚Ø¨ÙˆÙ„. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø³ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.";
      } else {
        message = "Ù„Ù„Ø£Ø³ÙØŒ Ù†ØªÙŠØ¬ØªÙƒ Ù„Ù… ØªÙƒÙ† Ø¬ÙŠØ¯Ø©. Ù†Ù†ØµØ­Ùƒ Ø¨Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¯Ø±Ø§Ø³Ø©.";
      }
      
      resultMessage.textContent = message;
    }

    async function submitExam(){
      console.log("submitExam: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙÙ†ÙƒØ´Ù†", { isSubmitting, autoSubmitted });

      // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ø£Ùˆ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ù…ÙƒØ±Ø±
      if (isSubmitting || autoSubmitted) {
        console.log("submitExam: ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø£Ù† isSubmitting/autoSubmitted ØµØ­ÙŠØ­");
        return;
      }

      // Ù‚ÙÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ±Ù‹Ø§
      isSubmitting = true;
      autoSubmitted = true;
      console.log("submitExam: Ø¶Ø¨Ø·Øª isSubmitting=true Ùˆ autoSubmitted=true");

      const totalScore = questions.length;
      let score = 0;

      const answersPayload = questions.map((q, i) => {
        const chosen = answers[i].chosen || null;
        const correct = q.type === "Ø§Ø®ØªÙŠØ§Ø±ÙŠ" ? (q.correctAnswer || null) : null;
        if (q.type === "Ø§Ø®ØªÙŠØ§Ø±ÙŠ" && chosen && correct && chosen === correct) score++;
        return {
          questionImage: q.questionImage || null,
          type: q.type || null,
          chosen: chosen,
          correct: correct
        };
      });

      const student = loadStudentFromStorage() || {};
      const payload = {
        name: student.name || "unknown",
        studentId: student.studentId || "unknown",
        grade: student.grade || "unknown",
        governorate: student.governorate || "unknown",
        examName: examDoc?.name || EXAM_NAME,
        totalScore,
        score,
        answers: answersPayload,
        createdAt: serverTimestamp()
      };

      console.log("submitExam: payload Ø¬Ø§Ù‡Ø²ØŒ Ø­Ø§ÙˆÙ„Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:", payload);

      try {
        const docRef = await addDoc(collection(db, "studentExam"), payload);
        console.log("submitExam: addDoc Ù†Ø¬Ø­ØŒ id:", docRef.id);
        clearInterval(timerInterval);
        showResult(score, totalScore);
      } catch(err) {
        console.error("submitExam: Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ addDoc:", err);

        // Ø§Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰
        const fallbackKey = "examSubmitFallback_" + (student.studentId || "unknown") + "_" + Date.now();
        try {
          localStorage.setItem(fallbackKey, JSON.stringify({ payload, error: String(err) }));
          console.warn("submitExam: Ø­ÙØ¸Øª Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ localStorage:", fallbackKey);
        } catch(e) {
          console.error("submitExam: ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:", e);
        }

        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©. ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ§Ù‹. ØªÙÙ‚Ø¯ Ø§Ù„Ù€ Console Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.");
        // ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§
        isSubmitting = false;
        autoSubmitted = false;
      }
    }

    endBtn.addEventListener("click", ()=>{
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§ØªØŸ")) {
        // Ø£ÙˆÙ‚Ù Ù…Ø¤Ù‚Øª Ù…Ù†Ø¹ Ø§Ù„ØºØ´ Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠÙØªÙƒØ±Ø´ Ø¥Ù†Ùƒ Ø®Ø±Ø¬Øª Ù…Ù† Ø§Ù„ØµÙØ­Ø©
        window.removeEventListener("blur", blurHandler);
        submitExam();
      }
    });

    

    // =================== Ø§Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ù†Ø¹ Ø§Ù„ØºØ´ ===================
    let blurHandler;

    function setupAntiCheat() {
      // Ù…Ù†Ø¹ ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ†
      document.addEventListener("contextmenu", e => e.preventDefault());

      // Ù…Ù†Ø¹ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù…Ø¹ÙŠÙ†Ø©
      document.addEventListener("keydown", (e) => {
        if (
          e.key === "F12" ||
          ((e.ctrlKey || e.metaKey) && ["c", "v", "x", "u", "s", "p"].includes(e.key.toLowerCase()))
        ) {
          e.preventDefault();
        }
      }, { capture: true });

      // ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
      window.addEventListener("beforeunload", (e) => {
        if (!autoSubmitted) {
          e.preventDefault();
          e.returnValue = "";
        }
      });

      // Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
      let blurLocked = false;

      blurHandler = () => {
        // Ù„Ùˆ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø®Ù„Øµ Ø£Ùˆ Ø¨ÙŠØªØ¨Ø¹ØªØŒ ØªØ¬Ø§Ù‡Ù„
        if (autoSubmitted || isSubmitting || blurLocked) return;

        blurLocked = true; // Ø§Ù‚ÙÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù„ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±

        // Ø¨Ø¹Ø¯ Ù†ØµÙ Ø«Ø§Ù†ÙŠØ© Ø§ÙØªØ­ ØªØ§Ù†ÙŠ (Ù„ØªÙØ§Ø¯ÙŠ blur Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ù€ alert Ù†ÙØ³Ù‡Ø§)
        setTimeout(() => (blurLocked = false), 500);

        warningsCount++;

        if (warningsCount === 1) {
          // Ø£ÙˆÙ„ Ù…Ø±Ù‘Ø© Ø®Ø±ÙˆØ¬ â†’ ØªØ­Ø°ÙŠØ± ÙÙ‚Ø·
          setTimeout(() => {
            alert("ØªØ­Ø°ÙŠØ±: Ø®Ø±Ø¬Øª Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†. Ø¥Ø°Ø§ ÙƒØ±Ø±Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.");
          }, 300);
        } else if (warningsCount === 2) {
          // Ø«Ø§Ù†ÙŠ Ù…Ø±Ù‘Ø© â†’ Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ±ÙŠ
          setTimeout(() => {
            alert("Ø®Ø±Ø¬Øª Ø¹Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø±Ø© ØªØ§Ù†ÙŠØ© â€” Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„Ø¢Ù†.");
            autoSubmitted = true;
            submitExam();
          }, 300);
        } else {
          console.log("ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.");
        }
      };

      window.addEventListener("blur", blurHandler);
    }
  </script>
</body>
</html>